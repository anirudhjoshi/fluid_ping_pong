this.CanvasRenderingContext2D&&!CanvasRenderingContext2D.createImageData&&(CanvasRenderingContext2D.prototype.createImageData=function(c,a){return this.getImageData(0,0,c,a)});
function Fluid(c){function a(m,b,f){for(var a=0;a<l;a++)m[a]=m[a]+f*b[a]}function u(m,b){if(m===1){for(var f=1;f<=i;f++){b[f]=b[f+e];b[f+(n+1)*e]=b[f+n*e]}for(var a=1;f<=n;f++){b[a*e]=-b[1+a*e];b[i+1+a*e]=-b[i+a*e]}}else{if(m===2)for(f=1;f<=i;f++){b[f]=-b[f+e];b[f+(n+1)*e]=-b[f+n*e]}else for(f=1;f<=i;f++){b[f]=b[f+e];b[f+(n+1)*e]=b[f+n*e]}for(a=1;a<=n;a++){b[a*e]=b[1+a*e];b[i+1+a*e]=b[i+a*e]}}f=(n+1)*e;b[0]=0.5*(b[1]+b[e]);b[f]=0.5*(b[1+f]+b[n*e]);b[i+1]=0.5*(b[i]+b[i+1+e]);b[i+1+f]=0.5*(b[i+f]+b[i+
1+n*e])}function t(m,b,a,c,g){if(c===0&&g===1){for(g=1;g<=n;g++){var d=g*e;++d;for(var h=0;h<i;h++){b[d]=a[d];++d}}u(m,b)}else for(var k=1/g,j=0;j<C;j++){for(g=1;g<=n;g++){var D=(g-1)*e,d=g*e,U=(g+1)*e,l=b[d];++d;for(h=1;h<=i;h++)l=b[d]=(a[d]+c*(l+b[++d]+b[++D]+b[++U]))*k}u(m,b)}}function v(m){for(var b=0;b<l;b++)m[b]=m[b]*V}function o(m,b,a,c,g,d){for(var h=d*i,d=d*n,k=i+0.5,j=n+0.5,D=1;D<=n;D++)for(var l=D*e,t=1;t<=i;t++){var o=t-h*c[++l],w=D-d*g[l];o<0.5?o=0.5:o>k&&(o=k);var s=o|0,v=s+1;w<0.5?
w=0.5:w>j&&(w=j);var p=w|0,o=o-s,w=w-p,A=1-w,B=p*e,p=(p+1)*e;b[l]=(1-o)*(A*a[s+B]+w*a[s+p])+o*(A*a[v+B]+w*a[v+p])}u(m,b)}function N(m,b,a,c){for(var g=-0.5/Math.sqrt(i*n),d=1;d<=n;d++)for(var h=d*e,k=(d-1)*e,j=h-1,l=h,o=h+1,h=(d+1)*e,p=1;p<=i;p++){c[++l]=g*(m[++o]-m[++j]+b[++h]-b[++k]);a[l]=0}u(0,c);u(0,a);t(0,a,c,1,4);c=0.5*i;g=0.5*n;for(d=1;d<=n;d++){k=d*e-1;j=d*e;l=d*e+1;o=(d-1)*e;h=(d+1)*e;for(p=1;p<=i;p++){m[++j]-=c*(a[++l]-a[++k]);b[j]=b[j]-g*(a[++h]-a[++o])}}u(1,m);u(2,b)}function O(a,b,c,
q,g){this.setDensityRGB=function(d,h,g){a[d+1+(h+1)*e]=g[0];b[d+1+(h+1)*e]=g[1];c[d+1+(h+1)*e]=g[2]};this.getDensityRGB=function(d,h){return[a[d+1+(h+1)*e],b[d+1+(h+1)*e],c[d+1+(h+1)*e]]};this.setVelocity=function(a,b,m,c){q[a+1+(b+1)*e]=m;g[a+1+(b+1)*e]=c};this.setVelocityInterp=function(a,b,m,c){var f=e;rI=a+2;rJ=b+2;i1=a+2;i2=rI-i1<0?a+3:a+1;j1=b+2;j2=rJ-j1<0?b+3:b+1;diffx=1-(rI-i1);diffy=1-(rJ-j1);vx1=m*diffx*diffy;vy1=c*diffy*diffx;vx2=m*(1-diffx)*diffy;vy2=c*diffy*(1-diffx);vx3=m*diffx*(1-diffy);
vy3=c*(1-diffy)*diffx;vx4=m*(1-diffx)*(1-diffy);vy4=c*(1-diffy)*(1-diffx);if(!(i1<2||i1>e-1||j1<2||j1>f-1)){this.setVelocity(i1,j1,vx1,vy1);this.setVelocity(i2,j1,vx2,vy2);this.setVelocity(i1,j2,vx3,vy3);this.setVelocity(i2,j2,vx4,vy4)}};this.getXVelocity=function(a,b){return q[a+1+(b+1)*e]};this.getYVelocity=function(a,b){return g[a+1+(b+1)*e]};this.width=function(){return i};this.height=function(){return n}}function P(){e=i+2;l=(i+2)*(n+2);F=Array(l);G=Array(l);H=Array(l);I=Array(l);J=Array(l);
K=Array(l);A=Array(l);B=Array(l);E=Array(l);M=Array(l);for(var a=0;a<l;a++){B[a]=M[a]=A[a]=E[a]=0;F[a]=H[a]=J[a]=G[a]=I[a]=K[a]=0}}function W(a){var b=c.getContext("2d"),f=a.width(),e=a.height();a:if(!p||!(p.width==a.width()&&p.height==a.height())){p=document.createElement("canvas");p.width=a.width();p.height=a.height();var g=p.getContext("2d");try{s=g.createImageData(a.width(),a.height())}catch(d){break a}if(s){for(var g=a.width()*a.height()*4,h=3;h<g;h=h+4)s.data[h]=255;s.data[0]=256;s.data[0]>
255&&(Q=true);s.data[0]=0}}pong.ball.vy=pong.ball.vy+a.getYVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/5;pong.ball.vx=pong.ball.vx+a.getXVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/5;if(s){g=s.data;if(Q)for(h=0;h<f;h++)for(var k=0;k<e;k++){var j=a.getDensity(h,k)*255/5,j=j|0;j>255&&(j=255);g[4*(k*e+h)+1]=j}else for(h=0;h<f;h++)for(k=0;k<e;k++){var j=4*(k*e+h),i=a.getDensityRGB(h,k);g[j+0]=Math.round(i[0]*255/5);g[j+1]=Math.round(i[1]*255/5);g[j+2]=Math.round(i[2]*255/5)}b.putImageData(s,
0,0)}else for(h=0;h<f;h++)for(k=0;k<e;k++){j=a.getDensity(h,k)/5;b.setFillColor(0,j,0,1);b.fillRect(h,k,1,1)}}function X(a){var b=c.getContext("2d");b.save();b.lineWidth=1;var f=c.width/a.width(),e=c.height/a.height();b.fillStyle="black";b.fillRect(0,0,c.width,c.height);b.strokeStyle="rgb(0,255,0)";b.beginPath();for(var g=0;g<a.width();g++)for(var d=0;d<a.height();d++){b.moveTo(g*f+0.5*f,d*e+0.5*e);b.lineTo((g+0.5+10*a.getXVelocity(g,d))*f,(d+0.5+10*a.getYVelocity(g,d))*e)}b.stroke();b.restore()}
var V=0.99,R=function(){};this.update=function(){for(var c=G,b=I,f=K,q=B,g=M,d=0;d<l;d++)c[d]=b[d]=f[d]=0;R(new O(c,b,f,q,g));c=A;b=E;f=B;q=M;g=S;a(c,f,g);a(b,q,g);for(var d=f,f=c,c=d,d=q,q=b,b=d,d=c,h=f,k=b,j=q,p=1;p<=n;p++){var s=p*e;++s;for(var C=0;C<i;C++){d[s]=h[s];k[s]=j[s];++s}}u(1,d);u(2,k);N(c,b,f,q);d=f;f=c;c=d;d=q;q=b;b=d;o(1,c,f,f,q,g);o(2,b,q,f,q,g);N(c,b,f,q);if(B){c=G;b=I;f=K;q=F;g=H;d=J;h=A;k=E;j=S;v(q);v(g);v(d);a(q,c,j);a(g,b,j);a(d,f,j);t(0,c,q,0,1);t(0,b,g,0,1);t(0,f,d,0,1);o(0,
q,c,h,k,j);o(0,g,b,h,k,j);o(0,d,f,h,k,j)}T(new O(F,H,J,A,E))};this.setDisplayFunction=function(a){T=a};this.iterations=function(){return C};this.setIterations=function(a){a>0&&a<=100&&(C=a)};this.setUICallback=function(a){R=a};var C=10,S=0.1,F,G,H,I,J,K,A,B,E,M,i,n,e,l,T;this.reset=P;this.setResolution=function(a,b){var c=b*a;if(c>0&&c<1E6&&(b!=i||a!=n)){i=b;n=a;P();return true}return false};var p,s,Q=false,c=document.getElementById("canvas");this.toggleDisplayFunction=function(a,b){if(b){a.width=
displaySize;a.height=displaySize;return X}a.width=fieldRes;a.height=fieldRes;return W}};function Pong(c){this.canvas=c;this.ctx=this.canvas.getContext("2d");this.theta=0;this.speed_increase=0.7;this.speed=1;this.ball={x:0,y:0,xo:0,yo:0,out:!1,radius:0,speed:1,color:"red",vx:0,vy:0,ax:0.001,ay:0.001};this.ai={push:!0,suck:!1,stream:[0,0,0],multiplayer:!1,x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.player={push:!1,suck:!1,explode:!1,stream:[0,0,0],x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.updatePlayer=function(){this.keyMap.up.on&&(this.player.ay=
-this.speed_increase,this.player.vy<-this.speed&&(this.player.vy=-this.speed));this.player.push=this.keyMap.right.on?!0:!1;this.player.suck=this.keyMap.left.on?!0:!1;this.keyMap.down.on&&(this.player.ay=this.speed_increase,this.player.vy>this.speed&&(this.player.vy=this.speed));if(!this.keyMap.down.on&&!this.keyMap.up.on||this.keyMap.down.on&&this.keyMap.up.on)this.player.ay=0,this.player.vy=0;if(0>this.player.y&&0>this.player.vy||this.player.y+this.player.height>this.ctx.canvas.height&&0<this.player.vy)this.player.ay=
0,this.player.vy=0;this.player.vy+=this.player.ay;this.player.y+=this.player.vy};this.updateAi=function(){var a=0;if(this.ai.multiplayer){this.ai.vy+=this.ai.ay;this.keyMap.up2.on&&(this.ai.ay=-this.speed_increase,this.ai.vy<-this.speed&&(this.ai.vy=-this.speed));this.ai.push=this.keyMap.left2.on?!0:!1;this.ai.suck=this.keyMap.right2.on?!0:!1;this.keyMap.down2.on&&(this.ai.ay=this.speed_increase,this.ai.vy>this.speed&&(this.ai.vy=this.speed));if(!this.keyMap.down2.on&&!this.keyMap.up2.on||this.keyMap.down2.on&&
this.keyMap.up2.on)this.ai.ay=0,this.ai.vy=0;if(0>this.ai.y&&0>this.ai.vy||this.ai.y+this.ai.height>this.ctx.canvas.height&&0<this.ai.vy)this.ai.ay=0,this.ai.vy=0;this.ai.y+=this.ai.vy}else a=this.ai.y+this.ai.height/2,0>this.ball.vx?a<this.ctx.canvas.height/2-this.ctx.canvas.height/10?this.ai.y+=this.speed:a>this.ctx.canvas.height/2+this.ctx.canvas.height/10&&(this.ai.y-=this.speed):0<this.ball.vx&&2<Math.abs(this.ball.y-a)&&(this.ball.y<a?this.ai.y-=this.speed:this.ball.y>a&&(this.ai.y+=this.speed))};
this.updateBall=function(){Math.abs(this.ball.x-this.player.x)<Math.abs(this.ball.vx)&&(this.player.y<this.ball.y+0.1*this.player.height&&this.ball.y<this.player.y+1.1*this.player.height)&&(this.theta=(this.player.y+this.player.height/2-this.ball.y)/(this.player.height/2),this.ball.vx=this.ball.speed*Math.cos(this.theta),this.ball.vy=-this.ball.speed*Math.sin(this.theta));Math.abs(this.ball.x-this.ai.x)<this.ball.vx&&(this.ball.y>this.ai.y&&this.ball.y<this.ai.y+this.ai.height)&&(this.theta=(this.ai.y+
this.ai.height/2-this.ball.y)/(this.ai.height/2),this.ball.vx=-this.ball.speed*Math.cos(this.theta),this.ball.vy=this.ball.speed*Math.sin(this.theta));if(0>this.ball.y&&0>this.ball.vy||this.ball.y+this.ball.radius>this.ctx.canvas.height&&0<this.ball.vy)this.ball.vy=-this.ball.vy;if(0>this.ball.x&&0>this.ball.vx||this.ball.x+this.ball.radius>this.ctx.canvas.width&&0<this.ball.vx)if(this.ball.xo=this.ball.x,this.ball.yo=this.ball.y,this.ball.out=!0,this.ball.x=(this.ctx.canvas.width-this.ball.radius)/
2,this.ball.y=this.ctx.canvas.height/2,this.theta=2*Math.random()*Math.PI,this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4),this.theta>Math.PI+Math.PI/4&&this.theta<3*Math.PI/4+Math.PI&&(this.theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI),this.ball.vx=this.ball.speed*Math.cos(this.theta),this.ball.vy=this.ball.speed*Math.sin(this.theta),1===Math.round(Math.random()))this.ball.vy=-this.ball.vy;this.ball.x+=this.ball.vx;
this.ball.y+=this.ball.vy};this.distance=function(a,c){return Math.sqrt(Math.pow(c.x-a.x,2)+Math.pow(c.y-a.y,2))};this.update=function(){this.updatePlayer();this.updateAi();this.updateBall()};this.clear=function(){this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);this.ctx.restore()};this.drawRectangle=function(a,c,t,v,o){this.ctx.fillStyle=o instanceof Array?"rgb("+Math.floor(o[0])+","+Math.floor(o[1])+","+Math.floor(o[2])+")":
o;this.ctx.fillRect(a,c,t,v)};this.drawPlayer=function(a){this.drawRectangle(a.x,a.y,a.width,a.height,a.color)};this.drawBall=function(a){this.ctx.beginPath();this.ctx.lineWidth=0.5;this.ctx.fillStyle="black";this.ctx.strokeStyle="white";this.ctx.arc(a.x,a.y,a.radius,0,2*Math.PI,!1);this.ctx.fill();this.ctx.stroke()};this.render=function(){this.drawPlayer(this.player);this.drawPlayer(this.ai);this.drawBall(this.ball)};this.loop=function(){this.update();this.render()};this.init=function(){var a=this.ctx.canvas.width/
75,c=this.ctx.canvas.height/6,t=this.ctx.canvas.width,v=this.ctx.canvas.height;this.ai.width=a;this.ai.height=c;this.ai.x=t-this.ai.width;this.ai.y=v/2;this.player.width=a;this.player.height=c;this.player.y=v/2;this.ball.radius=2*a;this.theta=Math.PI;this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4);this.theta>Math.PI+Math.PI/4&&this.theta<3*Math.PI/4+Math.PI&&(this.theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI);
this.ball.vx=this.ball.speed*Math.cos(this.theta);this.ball.vy=this.ball.speed*Math.sin(this.theta);this.ball.x=this.ctx.canvas.width/2;this.ball.y=this.ctx.canvas.height/2};this.keyMap={left:{code:65,on:!1},up:{code:87,on:!1},right:{code:68,on:!1},down:{code:83,on:!1},left2:{code:74,on:!1},up2:{code:73,on:!1},right2:{code:76,on:!1},down2:{code:75,on:!1}}};var res,displaySize=512,fieldRes,clear_id,running=!1,canvas=document.getElementById("canvas"),L=75,distanceRotators=[0,201,401];function multiplayer(){pong.ai.multiplayer=pong.ai.multiplayer?!1:!0;pong.ai.push=!0}function restart(){begin()}function rotator(c){if(0<=c&&200>=c)return[200-(100+c),100];if(200<c&&400>=c)return[-100+(c-200),100-(c-200)];if(400<c&&600>=c)return[100,-100+(c-400)]}var field,pong;function explosion(){}var counter=0,suck_counter_1=100;
function prepareFrame(c){var a=rotator(distanceRotators[0]),u=rotator(distanceRotators[1]),t=rotator(distanceRotators[2]);pong.player.color=cielabToRGB(L,a[0],a[1],[0.9642,1,0.8249]);pong.ai.color=cielabToRGB(L,u[0],u[1],[0.9642,1,0.8249]);pong.ball.color=cielabToRGB(L,t[0],t[1],[0.9642,1,0.8249]);for(a=0;3>a;a++)distanceRotators[a]++,600<distanceRotators[a]&&(distanceRotators[a]=0);c.setDensityRGB(Math.floor(pong.ball.x+pong.ball.radius/2),Math.floor(pong.ball.y+pong.ball.radius/2),pong.ball.color);
pong.player.push&&(c.setVelocity(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),50,0),c.setDensityRGB(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),pong.player.color));if(pong.ball.out&&(pong.ball.xo>canvas.width/2?(a=canvas.width-1,u=-1):(u=1,a=0),c.setDensityRGB(a,Math.floor(pong.ball.yo+pong.ball.radius/2),pong.ball.color),c.setVelocity(a,Math.floor(pong.ball.yo+pong.ball.radius/2),1E3*u,0),counter++,12==
counter))pong.ball.out=!1,counter=0;pong.player.suck&&(a=pong.distance(pong.player,pong.ball),90<suck_counter_1&100>=suck_counter_1?(c.setVelocity(0,Math.floor(pong.player.y+pong.player.height/2),1E3,0),c.setDensityRGB(0,Math.floor(pong.player.y+pong.player.height/2),pong.player.color),a=100):0==suck_counter_1&&(suck_counter_1=100),20>a&&(pong.ball.x=pong.player.x+10+Math.random(),pong.ball.y=pong.player.y+pong.player.height/2+Math.random(),pong.ball.vx=0,pong.ball.vy=0),suck_counter_1--);pong.ai.push&&
(c.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-50,0),c.setDensityRGB(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),pong.ai.color));pong.ai.suck&&c.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-1E3,0);pong.ball.vy+=c.getYVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y));pong.ball.vx+=c.getXVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))}
function switchAnimation(){running?(running=!1,document.getElementById("switch").innerHTML="Unpause"):(running=!0,document.getElementById("switch").innerHTML="Pause")}var white=[0.9642,1,0.8249];function cielabToRGB(c,a,u,t){x=255*t[0]*inverseCielab(1/116*(c+16)+0.002*a);y=255*t[1]*inverseCielab(1/116*(c+16));z=255*t[2]*inverseCielab(1/116*(c+16)+0.005*u);return[x,y,z]}function inverseCielab(c){return c>6/29?Math.pow(c,3):3*Math.pow(6/29,2)*(c-4/29)}function startAnimation(){running=!0}
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c){window.setTimeout(c,1E3/60)}}();(function animloop(){requestAnimFrame(animloop);updateFrame()})();var filterStrength=20,frameTime=0,lastLoop=new Date,thisLoop,avg=Array(120),avg_index=0,avgs=0,avgs_index=0,benchmarking=!1;
function run_benchmark(){var c=(thisLoop=new Date)-lastLoop;frameTime+=(c-frameTime)/filterStrength;lastLoop=thisLoop;avg[avg_index]=1E3/frameTime;if(6<avg_index){for(var a=c=0;a<avg_index;a++)c+=avg[avg_index];1<avgs_index&&(60>avgs&&updateRes(24),benchmarking=!1);avgs+=c/avg_index;avgs_index++;avg_index=0}avg_index++}function updateFrame(){running&&(benchmarking&&run_benchmark(),field.update(),pong.loop())}var r=96;
function updateRes(c){canvas.width=c;fieldRes=canvas.height=c;field.setResolution(c,c);pong.init()}var keyDown=function(c){for(var a in pong.keyMap)if(pong.keyMap.hasOwnProperty(a)&&c.keyCode===pong.keyMap[a].code){pong.keyMap[a].on=!0;break}},keyUp=function(c){for(var a in pong.keyMap)if(pong.keyMap.hasOwnProperty(a)&&c.keyCode===pong.keyMap[a].code){pong.keyMap[a].on=!1;break}};
function begin(){field=new Fluid(canvas);field.setUICallback(prepareFrame);field.setDisplayFunction(field.toggleDisplayFunction(canvas,0));pong=new Pong(canvas);window.addEventListener("keydown",keyDown,!1);window.addEventListener("keyup",keyUp,!1);updateRes(r);startAnimation()}window.onload=begin;
