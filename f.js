this.CanvasRenderingContext2D&&!CanvasRenderingContext2D.createImageData&&(CanvasRenderingContext2D.prototype.createImageData=function(b,a){return this.getImageData(0,0,b,a)});
function FluidField(){function b(a,c,d){for(var b=0;b<q;b++)a[b]=a[b]+d*c[b]}function a(a,c){if(a===1){for(var d=1;d<=o;d++){c[d]=c[d+h];c[d+(p+1)*h]=c[d+p*h]}for(var b=1;d<=p;d++){c[b*h]=-c[1+b*h];c[o+1+b*h]=-c[o+b*h]}}else{if(a===2)for(d=1;d<=o;d++){c[d]=-c[d+h];c[d+(p+1)*h]=-c[d+p*h]}else for(d=1;d<=o;d++){c[d]=c[d+h];c[d+(p+1)*h]=c[d+p*h]}for(b=1;b<=p;b++){c[b*h]=c[1+b*h];c[o+1+b*h]=c[o+b*h]}}d=(p+1)*h;c[0]=0.5*(c[1]+c[h]);c[d]=0.5*(c[1+d]+c[p*h]);c[o+1]=0.5*(c[o]+c[o+1+h]);c[o+1+d]=0.5*(c[o+
d]+c[o+1+p*h])}function g(b,c,d,e,g){if(e===0&&g===1){for(g=1;g<=p;g++){var f=g*h;++f;for(var s=0;s<o;s++){c[f]=d[f];++f}}a(b,c)}else for(var A=1/g,u=0;u<i;u++){for(g=1;g<=p;g++){var n=(g-1)*h,f=g*h,j=(g+1)*h,m=c[f];++f;for(s=1;s<=o;s++)m=c[f]=(d[f]+e*(m+c[++f]+c[++n]+c[++j]))*A}a(b,c)}}function e(a){for(var c=0;c<q;c++)a[c]=a[c]*C}function j(b,c,d,g,e,f){for(var s=f*o,f=f*p,A=o+0.5,u=p+0.5,n=1;n<=p;n++)for(var j=n*h,m=1;m<=o;m++){var l=m-s*g[++j],k=n-f*e[j];l<0.5?l=0.5:l>A&&(l=A);var i=l|0,t=i+1;
k<0.5?k=0.5:k>u&&(k=u);var q=k|0,l=l-i,k=k-q,v=1-k,B=q*h,q=(q+1)*h;c[j]=(1-l)*(v*d[i+B]+k*d[i+q])+l*(v*d[t+B]+k*d[t+q])}a(b,c)}function m(b,c,d,e){for(var A=-0.5/Math.sqrt(o*p),f=1;f<=p;f++)for(var s=f*h,n=(f-1)*h,k=s-1,l=s,j=s+1,s=(f+1)*h,m=1;m<=o;m++){e[++l]=A*(b[++j]-b[++k]+c[++s]-c[++n]);d[l]=0}a(0,e);a(0,d);g(0,d,e,1,4);e=0.5*o;A=0.5*p;for(f=1;f<=p;f++){n=f*h-1;k=f*h;l=f*h+1;j=(f-1)*h;s=(f+1)*h;for(m=1;m<=o;m++){b[++k]-=e*(d[++l]-d[++n]);c[k]=c[k]-A*(d[++s]-d[++j])}}a(1,b);a(2,c)}function A(a,
b,d,g,e){this.setDensityRGB=function(f,g,e){a[f+1+(g+1)*h]=e[0];b[f+1+(g+1)*h]=e[1];d[f+1+(g+1)*h]=e[2]};this.getDensityRGB=function(f,g){return[a[f+1+(g+1)*h],b[f+1+(g+1)*h],d[f+1+(g+1)*h]]};this.setVelocity=function(a,b,c,d){g[a+1+(b+1)*h]=c;e[a+1+(b+1)*h]=d};this.setVelocityInterp=function(a,b,c,d){var g=h;rI=a+2;rJ=b+2;i1=a+2;i2=rI-i1<0?a+3:a+1;j1=b+2;j2=rJ-j1<0?b+3:b+1;diffx=1-(rI-i1);diffy=1-(rJ-j1);vx1=c*diffx*diffy;vy1=d*diffy*diffx;vx2=c*(1-diffx)*diffy;vy2=d*diffy*(1-diffx);vx3=c*diffx*
(1-diffy);vy3=d*(1-diffy)*diffx;vx4=c*(1-diffx)*(1-diffy);vy4=d*(1-diffy)*(1-diffx);if(!(i1<2||i1>h-1||j1<2||j1>g-1)){this.setVelocity(i1,j1,vx1,vy1);this.setVelocity(i2,j1,vx2,vy2);this.setVelocity(i1,j2,vx3,vy3);this.setVelocity(i2,j2,vx4,vy4)}};this.getXVelocity=function(a,b){return g[a+1+(b+1)*h]};this.getYVelocity=function(a,b){return e[a+1+(b+1)*h]};this.width=function(){return o};this.height=function(){return p}}function n(){h=o+2;q=(o+2)*(p+2);l=Array(q);k=Array(q);t=Array(q);D=Array(q);I=
Array(q);J=Array(q);F=Array(q);G=Array(q);H=Array(q);K=Array(q);for(var a=0;a<q;a++){G[a]=K[a]=F[a]=H[a]=0;l[a]=t[a]=I[a]=k[a]=D[a]=J[a]=0}}var C=0.99,v=function(){};this.update=function(){for(var n=k,c=D,d=J,i=G,w=K,f=0;f<q;f++)i[f]=w[f]=n[f]=c[f]=d[f]=0;v(new A(n,c,d,i,w));n=F;c=H;d=G;i=K;w=B;b(n,d,w);b(c,i,w);for(var f=d,d=n,n=f,f=i,i=c,c=f,f=n,s=d,C=c,u=i,M=1;M<=p;M++){var E=M*h;++E;for(var N=0;N<o;N++){f[E]=s[E];C[E]=u[E];++E}}a(1,f);a(2,C);m(n,c,d,i);f=d;d=n;n=f;f=i;i=c;c=f;j(1,n,d,d,i,w);j(2,
c,i,d,i,w);m(n,c,d,i);if(G){n=k;c=D;d=J;i=l;w=t;f=I;s=F;C=H;u=B;e(i);e(w);e(f);b(i,n,u);b(w,c,u);b(f,d,u);g(0,n,i,0,1);g(0,c,w,0,1);g(0,d,f,0,1);j(0,i,n,s,C,u);j(0,w,c,s,C,u);j(0,f,d,s,C,u)}O(new A(l,t,I,F,H))};this.setDisplayFunction=function(a){O=a};this.iterations=function(){return i};this.setIterations=function(a){a>0&&a<=100&&(i=a)};this.setUICallback=function(a){v=a};var i=10,B=0.1,l,k,t,D,I,J,F,G,H,K,o,p,h,q,O;this.reset=n;this.setResolution=function(a,b){var d=b*a;if(d>0&&d<1E6&&(b!=o||a!=
p)){o=b;p=a;n();return true}return false};this.buffer=null}
(function(){function b(a){a:if(!g||!(g.width==a.width()&&g.height==a.height())){g=document.createElement("canvas");g.width=a.width();g.height=a.height();var b=g.getContext("2d");try{e=b.createImageData(a.width(),a.height())}catch(C){break a}if(e){for(var b=a.width()*a.height()*4,v=3;v<b;v=v+4)e.data[v]=255;e.data[0]=256;e.data[0]>255&&(j=true);e.data[0]=0}}var b=m.getContext("2d"),v=a.width(),i=a.height();pong.ball.vy=pong.ball.vy+a.getYVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/7;
pong.ball.vx=pong.ball.vx+a.getXVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/7;if(e){var B=e.data;if(j)for(var l=0;l<v;l++)for(var k=0;k<i;k++){var t=a.getDensity(l,k)*255/5,t=t|0;t>255&&(t=255);B[4*(k*i+l)+1]=t}else for(l=0;l<v;l++)for(k=0;k<i;k++){var t=4*(k*i+l),D=a.getDensityRGB(l,k);B[t+0]=Math.round(D[0]*255/5);B[t+1]=Math.round(D[1]*255/5);B[t+2]=Math.round(D[2]*255/5)}b.putImageData(e,0,0)}else for(l=0;l<v;l++)for(k=0;k<i;k++){t=a.getDensity(l,k)/5;b.setFillColor(0,t,0,1);b.fillRect(l,
k,1,1)}}function a(a){var b=m.getContext("2d");b.save();b.lineWidth=1;var g=m.width/a.width(),e=m.height/a.height();b.fillStyle="black";b.fillRect(0,0,m.width,m.height);b.strokeStyle="rgb(0,255,0)";b.beginPath();for(var i=0;i<a.width();i++)for(var j=0;j<a.height();j++){b.moveTo(i*g+0.5*g,j*e+0.5*e);b.lineTo((i+0.5+10*a.getXVelocity(i,j))*g,(j+0.5+10*a.getYVelocity(i,j))*e)}b.stroke();b.restore()}var g,e,j=false,m=document.getElementById("canvas");toggleDisplayFunction=function(g,e){if(e){g.width=
displaySize;g.height=displaySize;return a}g.width=fieldRes;g.height=fieldRes;return b}})();function Pong(b){this.canvas=b;this.ctx=this.canvas.getContext("2d");this.theta=0;this.speed_increase=0.7;this.speed=1;this.ball={x:0,y:0,xo:0,yo:0,out:!1,radius:0,speed:1,color:"red",vx:0,vy:0,ax:0.001,ay:0.001};this.ai={push:!0,suck:!1,stream:[0,0,0],multiplayer:!1,x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.player={push:!1,suck:!1,explode:!1,stream:[0,0,0],x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.updatePlayer=function(){this.keyMap.up.on&&(this.player.ay=
-this.speed_increase,this.player.vy<-this.speed&&(this.player.vy=-this.speed));this.player.push=this.keyMap.right.on?!0:!1;this.player.suck=this.keyMap.left.on?!0:!1;this.keyMap.down.on&&(this.player.ay=this.speed_increase,this.player.vy>this.speed&&(this.player.vy=this.speed));if(!this.keyMap.down.on&&!this.keyMap.up.on||this.keyMap.down.on&&this.keyMap.up.on)this.player.ay=0,this.player.vy=0;if(0>this.player.y&&0>this.player.vy||this.player.y+this.player.height>this.ctx.canvas.height&&0<this.player.vy)this.player.ay=
0,this.player.vy=0;this.player.vy+=this.player.ay;this.player.y+=this.player.vy};this.updateAi=function(){var a=0;if(this.ai.multiplayer){this.ai.vy+=this.ai.ay;this.keyMap.up2.on&&(this.ai.ay=-this.speed_increase,this.ai.vy<-this.speed&&(this.ai.vy=-this.speed));this.ai.push=this.keyMap.left2.on?!0:!1;this.ai.suck=this.keyMap.right2.on?!0:!1;this.keyMap.down2.on&&(this.ai.ay=this.speed_increase,this.ai.vy>this.speed&&(this.ai.vy=this.speed));if(!this.keyMap.down2.on&&!this.keyMap.up2.on||this.keyMap.down2.on&&
this.keyMap.up2.on)this.ai.ay=0,this.ai.vy=0;if(0>this.ai.y&&0>this.ai.vy||this.ai.y+this.ai.height>this.ctx.canvas.height&&0<this.ai.vy)this.ai.ay=0,this.ai.vy=0;this.ai.y+=this.ai.vy}else a=this.ai.y+this.ai.height/2,0>this.ball.vx?a<this.ctx.canvas.height/2-this.ctx.canvas.height/10?this.ai.y+=this.speed:a>this.ctx.canvas.height/2+this.ctx.canvas.height/10&&(this.ai.y-=this.speed):0<this.ball.vx&&2<Math.abs(this.ball.y-a)&&(this.ball.y<a?this.ai.y-=this.speed:this.ball.y>a&&(this.ai.y+=this.speed))};
this.updateBall=function(){var a=this.ball,b=this.player,e=this.theta,j=this.ai,m=this.ctx;Math.abs(a.x-b.x)<Math.abs(a.vx)&&(b.y<a.y+0.1*b.height&&a.y<b.y+1.1*b.height)&&(e=(b.y+b.height/2-a.y)/(b.height/2),a.vx=a.speed*Math.cos(e),a.vy=-a.speed*Math.sin(e));Math.abs(a.x-j.x)<a.vx&&(a.y>j.y&&a.y<j.y+j.height)&&(e=(j.y+j.height/2-a.y)/(j.height/2),a.vx=-a.speed*Math.cos(e),a.vy=a.speed*Math.sin(e));if(0>a.y&&0>a.vy||a.y+a.radius>m.canvas.height&&0<a.vy)a.vy=-a.vy;if(0>a.x&&0>a.vx||a.x+a.radius>m.canvas.width&&
0<a.vx)a.xo=a.x,a.yo=a.y,a.out=!0,a.x=(m.canvas.width-a.radius)/2,a.y=m.canvas.height/2,e=2*Math.random()*Math.PI,e>Math.PI/4&&e<3*Math.PI/4&&(e=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4),e>Math.PI+Math.PI/4&&e<3*Math.PI/4+Math.PI&&(e=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI),a.vx=a.speed*Math.cos(e),a.vy=a.speed*Math.sin(e),1===Math.round(Math.random())&&(a.vy=-a.vy);a.vx+=a.ax;a.x+=a.vx;a.vy+=a.ay;a.y+=a.vy;this.ball=a};this.distance=function(a,b){return Math.sqrt(Math.pow(b.x-
a.x,2)+Math.pow(b.y-a.y,2))};this.update=function(){this.updatePlayer();this.updateAi();this.updateBall()};this.clear=function(){var a=this.ctx;a.save();a.setTransform(1,0,0,1,0,0);a.clearRect(0,0,a.canvas.width,a.canvas.height);a.restore()};this.drawRectangle=function(a,b,e,j,m){this.ctx.fillStyle=m instanceof Array?"rgb("+Math.floor(m[0])+","+Math.floor(m[1])+","+Math.floor(m[2])+")":m;this.ctx.fillRect(a,b,e,j)};this.drawPlayer=function(a){this.drawRectangle(a.x,a.y,a.width,a.height,a.color)};
this.drawBall=function(a){this.ctx.beginPath();this.ctx.lineWidth=0.5;this.ctx.fillStyle="black";this.ctx.strokeStyle="white";this.ctx.arc(a.x,a.y,a.radius,0,2*Math.PI,!1);this.ctx.fill();this.ctx.stroke()};this.render=function(){this.drawPlayer(this.player);this.drawPlayer(this.ai);this.drawBall(this.ball)};this.loop=function(){this.update();this.render()};this.init=function(){var a=this.ctx.canvas.width/75,b=this.ctx.canvas.height/6,e=this.ctx.canvas.width,j=this.ctx.canvas.height;this.ai.width=
a;this.ai.height=b;this.ai.x=e-this.ai.width;this.ai.y=j/2;this.player.width=a;this.player.height=b;this.player.y=j/2;this.ball.radius=2*a;this.theta=Math.PI;this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4);this.theta>Math.PI+Math.PI/4&&this.theta<3*Math.PI/4+Math.PI&&(this.theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI);this.ball.vx=this.ball.speed*Math.cos(this.theta);this.ball.vy=this.ball.speed*Math.sin(this.theta);
this.ball.x=this.ctx.canvas.width/2;this.ball.y=this.ctx.canvas.height/2};this.keyMap={left:{code:65,on:!1},up:{code:87,on:!1},right:{code:68,on:!1},down:{code:83,on:!1},left2:{code:74,on:!1},up2:{code:73,on:!1},right2:{code:76,on:!1},down2:{code:75,on:!1}}};var res,displaySize=512,fieldRes,clear_id,running=!1,canvas=document.getElementById("canvas"),L=75,distanceRotators=[0,201,401];function multiplayer(){pong.ai.multiplayer=pong.ai.multiplayer?!1:!0;pong.ai.push=!0}function restart(){begin()}function rotator(b){if(0<=b&&200>=b)return[200-(100+b),100];if(200<b&&400>=b)return[-100+(b-200),100-(b-200)];if(400<b&&600>=b)return[100,-100+(b-400)]}var field,pong;function explosion(){}var counter=0,suck_counter_1=100;
function prepareFrame(b){var a=rotator(distanceRotators[0]),g=rotator(distanceRotators[1]),e=rotator(distanceRotators[2]);pong.player.color=cielabToRGB(L,a[0],a[1],[0.9642,1,0.8249]);pong.ai.color=cielabToRGB(L,g[0],g[1],[0.9642,1,0.8249]);pong.ball.color=cielabToRGB(L,e[0],e[1],[0.9642,1,0.8249]);for(a=0;3>a;a++)distanceRotators[a]++,600<distanceRotators[a]&&(distanceRotators[a]=0);b.setDensityRGB(Math.floor(pong.ball.x+pong.ball.radius/2),Math.floor(pong.ball.y+pong.ball.radius/2),pong.ball.color);
pong.player.push&&(b.setVelocity(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),50,0),b.setDensityRGB(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),pong.player.color));if(pong.ball.out&&(pong.ball.xo>canvas.width/2?(a=canvas.width-1,g=-1):(g=1,a=0),b.setDensityRGB(a,Math.floor(pong.ball.yo+pong.ball.radius/2),pong.ball.color),b.setVelocity(a,Math.floor(pong.ball.yo+pong.ball.radius/2),1E3*g,0),counter++,12==
counter))pong.ball.out=!1,counter=0;pong.player.suck&&(a=pong.distance(pong.player,pong.ball),90<suck_counter_1&100>=suck_counter_1?(b.setVelocity(0,Math.floor(pong.player.y+pong.player.height/2),1E3,0),b.setDensityRGB(0,Math.floor(pong.player.y+pong.player.height/2),pong.player.color),a=100):0==suck_counter_1&&(suck_counter_1=100),20>a&&(pong.ball.x=pong.player.x+10+Math.random(),pong.ball.y=pong.player.y+pong.player.height/2+Math.random(),pong.ball.vx=0,pong.ball.vy=0),console.log(suck_counter_1),
suck_counter_1--);pong.ai.push&&(b.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-50,0),b.setDensityRGB(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),pong.ai.color));pong.ai.suck&&b.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-1E3,0)}
function switchAnimation(){running?(running=!1,document.getElementById("switch").innerHTML="Unpause"):(running=!0,document.getElementById("switch").innerHTML="Pause")}var white=[0.9642,1,0.8249];function cielabToRGB(b,a,g,e){x=255*e[0]*inverseCielab(1/116*(b+16)+0.002*a);y=255*e[1]*inverseCielab(1/116*(b+16));z=255*e[2]*inverseCielab(1/116*(b+16)+0.005*g);return[x,y,z]}function inverseCielab(b){return b>6/29?Math.pow(b,3):3*Math.pow(6/29,2)*(b-4/29)}function startAnimation(){running=!0}
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1E3/60)}}();(function animloop(){requestAnimFrame(animloop);updateFrame()})();var filterStrength=20,frameTime=0,lastLoop=new Date,thisLoop,avg=Array(120),avg_index=0,avgs=0,avgs_index=0,benchmarking=!0;
function run_benchmark(){var b=(thisLoop=new Date)-lastLoop;frameTime+=(b-frameTime)/filterStrength;lastLoop=thisLoop;avg[avg_index]=1E3/frameTime;if(6<avg_index){for(var a=b=0;a<avg_index;a++)b+=avg[avg_index];console.log(b/avg_index,avg_index);1<avgs_index&&(60>avgs&&updateRes(24),benchmarking=!1);avgs+=b/avg_index;avgs_index++;avg_index=0}avg_index++}function updateFrame(){running&&(benchmarking&&run_benchmark(),field.update(),pong.loop())}var r=96;
function updateRes(b){canvas.width=b;fieldRes=canvas.height=b;field.setResolution(b,b);pong.init();pong.loop()}var keyDown=function(b){for(var a in pong.keyMap)if(pong.keyMap.hasOwnProperty(a)&&b.keyCode===pong.keyMap[a].code){pong.keyMap[a].on=!0;break}},keyUp=function(b){for(var a in pong.keyMap)if(pong.keyMap.hasOwnProperty(a)&&b.keyCode===pong.keyMap[a].code){pong.keyMap[a].on=!1;break}};
function begin(){field=new FluidField(canvas);field.setUICallback(prepareFrame);field.setDisplayFunction(toggleDisplayFunction(canvas,0));pong=new Pong(canvas);window.addEventListener("keydown",keyDown,!1);window.addEventListener("keyup",keyUp,!1);updateRes(r);startAnimation()}window.onload=begin;
