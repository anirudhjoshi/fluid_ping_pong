this.CanvasRenderingContext2D&&!CanvasRenderingContext2D.createImageData&&(CanvasRenderingContext2D.prototype.createImageData=function(a,c){return this.getImageData(0,0,a,c)});
function Fluid(a){function c(t,b,f){for(var a=0;a<m;a++)t[a]=t[a]+f*b[a]}function n(t,b){if(t===1){for(var f=1;f<=i;f++){b[f]=b[f+e];b[f+(o+1)*e]=b[f+o*e]}for(var a=1;f<=o;f++){b[a*e]=-b[1+a*e];b[i+1+a*e]=-b[i+a*e]}}else{if(t===2)for(f=1;f<=i;f++){b[f]=-b[f+e];b[f+(o+1)*e]=-b[f+o*e]}else for(f=1;f<=i;f++){b[f]=b[f+e];b[f+(o+1)*e]=b[f+o*e]}for(a=1;a<=o;a++){b[a*e]=b[1+a*e];b[i+1+a*e]=b[i+a*e]}}f=(o+1)*e;b[0]=0.5*(b[1]+b[e]);b[f]=0.5*(b[1+f]+b[o*e]);b[i+1]=0.5*(b[i]+b[i+1+e]);b[i+1+f]=0.5*(b[i+f]+b[i+
1+o*e])}function u(t,b,a,c,g){if(c===0&&g===1){for(g=1;g<=o;g++){var d=g*e;++d;for(var h=0;h<i;h++){b[d]=a[d];++d}}n(t,b)}else for(var k=1/g,j=0;j<C;j++){for(g=1;g<=o;g++){var D=(g-1)*e,d=g*e,U=(g+1)*e,m=b[d];++d;for(h=1;h<=i;h++)m=b[d]=(a[d]+c*(m+b[++d]+b[++D]+b[++U]))*k}n(t,b)}}function v(t){for(var b=0;b<m;b++)t[b]=t[b]*V}function p(t,b,a,c,g,d){for(var h=d*i,d=d*o,k=i+0.5,j=o+0.5,D=1;D<=o;D++)for(var m=D*e,u=1;u<=i;u++){var p=u-h*c[++m],w=D-d*g[m];p<0.5?p=0.5:p>k&&(p=k);var s=p|0,v=s+1;w<0.5?
w=0.5:w>j&&(w=j);var q=w|0,p=p-s,w=w-q,A=1-w,B=q*e,q=(q+1)*e;b[m]=(1-p)*(A*a[s+B]+w*a[s+q])+p*(A*a[v+B]+w*a[v+q])}n(t,b)}function N(a,b,c,l){for(var g=-0.5/Math.sqrt(i*o),d=1;d<=o;d++)for(var h=d*e,k=(d-1)*e,j=h-1,m=h,p=h+1,h=(d+1)*e,q=1;q<=i;q++){l[++m]=g*(a[++p]-a[++j]+b[++h]-b[++k]);c[m]=0}n(0,l);n(0,c);u(0,c,l,1,4);l=0.5*i;g=0.5*o;for(d=1;d<=o;d++){k=d*e-1;j=d*e;m=d*e+1;p=(d-1)*e;h=(d+1)*e;for(q=1;q<=i;q++){a[++j]-=l*(c[++m]-c[++k]);b[j]=b[j]-g*(c[++h]-c[++p])}}n(1,a);n(2,b)}function O(a,b,c,
l,g){this.setDensityRGB=function(d,h,g){a[d+1+(h+1)*e]=g[0];b[d+1+(h+1)*e]=g[1];c[d+1+(h+1)*e]=g[2]};this.getDensityRGB=function(d,h){return[a[d+1+(h+1)*e],b[d+1+(h+1)*e],c[d+1+(h+1)*e]]};this.setVelocity=function(a,b,t,c){l[a+1+(b+1)*e]=t;g[a+1+(b+1)*e]=c};this.setVelocityInterp=function(a,b,t,c){var f=e;rI=a+2;rJ=b+2;i1=a+2;i2=rI-i1<0?a+3:a+1;j1=b+2;j2=rJ-j1<0?b+3:b+1;diffx=1-(rI-i1);diffy=1-(rJ-j1);vx1=t*diffx*diffy;vy1=c*diffy*diffx;vx2=t*(1-diffx)*diffy;vy2=c*diffy*(1-diffx);vx3=t*diffx*(1-diffy);
vy3=c*(1-diffy)*diffx;vx4=t*(1-diffx)*(1-diffy);vy4=c*(1-diffy)*(1-diffx);if(!(i1<2||i1>e-1||j1<2||j1>f-1)){this.setVelocity(i1,j1,vx1,vy1);this.setVelocity(i2,j1,vx2,vy2);this.setVelocity(i1,j2,vx3,vy3);this.setVelocity(i2,j2,vx4,vy4)}};this.getXVelocity=function(a,b){return l[a+1+(b+1)*e]};this.getYVelocity=function(a,b){return g[a+1+(b+1)*e]};this.width=function(){return i};this.height=function(){return o}}function P(){e=i+2;m=(i+2)*(o+2);F=Array(m);G=Array(m);H=Array(m);I=Array(m);J=Array(m);
K=Array(m);A=Array(m);B=Array(m);E=Array(m);M=Array(m);for(var a=0;a<m;a++){B[a]=M[a]=A[a]=E[a]=0;F[a]=H[a]=J[a]=G[a]=I[a]=K[a]=0}}function W(c){var b=a.getContext("2d"),f=c.width(),e=c.height();a:if(!q||!(q.width==c.width()&&q.height==c.height())){q=document.createElement("canvas");q.width=c.width();q.height=c.height();var g=q.getContext("2d");try{s=g.createImageData(c.width(),c.height())}catch(d){break a}if(s){for(var g=c.width()*c.height()*4,h=3;h<g;h=h+4)s.data[h]=255;s.data[0]=256;s.data[0]>
255&&(Q=true);s.data[0]=0}}if(pong.display){pong.ball.vy=pong.ball.vy+c.getYVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/5;pong.ball.vx=pong.ball.vx+c.getXVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/5}if(s){g=s.data;if(Q)for(h=0;h<f;h++)for(var k=0;k<e;k++){var j=c.getDensity(h,k)*255/5,j=j|0;j>255&&(j=255);g[4*(k*e+h)+1]=j}else for(h=0;h<f;h++)for(k=0;k<e;k++){var j=4*(k*e+h),i=c.getDensityRGB(h,k);g[j+0]=Math.round(i[0]*255/5);g[j+1]=Math.round(i[1]*255/5);g[j+2]=Math.round(i[2]*
255/5)}b.putImageData(s,0,0)}else for(h=0;h<f;h++)for(k=0;k<e;k++){j=c.getDensity(h,k)/5;b.setFillColor(0,j,0,1);b.fillRect(h,k,1,1)}}function X(c){var b=a.getContext("2d");b.save();b.lineWidth=1;var f=a.width/c.width(),e=a.height/c.height();b.fillStyle="black";b.fillRect(0,0,a.width,a.height);b.strokeStyle="rgb(0,255,0)";b.beginPath();for(var g=0;g<c.width();g++)for(var d=0;d<c.height();d++){b.moveTo(g*f+0.5*f,d*e+0.5*e);b.lineTo((g+0.5+10*c.getXVelocity(g,d))*f,(d+0.5+10*c.getYVelocity(g,d))*e)}b.stroke();
b.restore()}var V=0.99,R=function(){};this.update=function(){for(var a=G,b=I,f=K,l=B,g=M,d=0;d<m;d++)a[d]=b[d]=f[d]=0;R(new O(a,b,f,l,g));a=A;b=E;f=B;l=M;g=S;c(a,f,g);c(b,l,g);for(var d=f,f=a,a=d,d=l,l=b,b=d,d=a,h=f,k=b,j=l,q=1;q<=o;q++){var s=q*e;++s;for(var C=0;C<i;C++){d[s]=h[s];k[s]=j[s];++s}}n(1,d);n(2,k);N(a,b,f,l);d=f;f=a;a=d;d=l;l=b;b=d;p(1,a,f,f,l,g);p(2,b,l,f,l,g);N(a,b,f,l);if(B){a=G;b=I;f=K;l=F;g=H;d=J;h=A;k=E;j=S;v(l);v(g);v(d);c(l,a,j);c(g,b,j);c(d,f,j);u(0,a,l,0,1);u(0,b,g,0,1);u(0,
f,d,0,1);p(0,l,a,h,k,j);p(0,g,b,h,k,j);p(0,d,f,h,k,j)}T(new O(F,H,J,A,E))};this.setDisplayFunction=function(a){T=a};this.iterations=function(){return C};this.setIterations=function(a){a>0&&a<=100&&(C=a)};this.setUICallback=function(a){R=a};var C=10,S=0.1,F,G,H,I,J,K,A,B,E,M,i,o,e,m,T;this.reset=P;this.setResolution=function(a,c){var e=c*a;if(e>0&&e<1E6&&(c!=i||a!=o)){i=c;o=a;P();return true}return false};var q,s,Q=false,a=document.getElementById("canvas");this.toggleDisplayFunction=function(a,c){if(c){a.width=
displaySize;a.height=displaySize;return X}a.width=fieldRes;a.height=fieldRes;return W}};function Pong(a){this.canvas=a;this.ctx=this.canvas.getContext("2d");this.theta=0;this.speed_increase=0.7;this.speed=1;this.display=!0;a=function(){this.push=!0;this.suck=!1;this.stream=[0,0,0];this.multiplayer=!1;this.height=this.width=this.y=this.x=0;this.color="red";this.yo=this.xo=this.ay=this.ax=this.vy=this.vx=0;this.out=!1;this.radius=0;this.speed=1};this.ball=new a;this.ai=new a;this.player=new a;this.updatePlayer=function(){this.keyMap.up.on&&(this.player.ay=-this.speed_increase,this.player.vy<
-this.speed&&(this.player.vy=-this.speed));this.player.push=this.keyMap.right.on?!0:!1;this.player.suck=this.keyMap.left.on?!0:!1;this.keyMap.down.on&&(this.player.ay=this.speed_increase,this.player.vy>this.speed&&(this.player.vy=this.speed));if(!this.keyMap.down.on&&!this.keyMap.up.on||this.keyMap.down.on&&this.keyMap.up.on)this.player.ay=0,this.player.vy=0;if(0>this.player.y&&0>this.player.vy||this.player.y+this.player.height>this.ctx.canvas.height&&0<this.player.vy)this.player.ay=0,this.player.vy=
0;this.player.vy+=this.player.ay;this.player.y+=this.player.vy};this.updateAi=function(){var a=0;if(this.ai.multiplayer){this.ai.vy+=this.ai.ay;this.keyMap.up2.on&&(this.ai.ay=-this.speed_increase,this.ai.vy<-this.speed&&(this.ai.vy=-this.speed));this.ai.push=this.keyMap.left2.on?!0:!1;this.ai.suck=this.keyMap.right2.on?!0:!1;this.keyMap.down2.on&&(this.ai.ay=this.speed_increase,this.ai.vy>this.speed&&(this.ai.vy=this.speed));if(!this.keyMap.down2.on&&!this.keyMap.up2.on||this.keyMap.down2.on&&this.keyMap.up2.on)this.ai.ay=
0,this.ai.vy=0;if(0>this.ai.y&&0>this.ai.vy||this.ai.y+this.ai.height>this.ctx.canvas.height&&0<this.ai.vy)this.ai.ay=0,this.ai.vy=0;this.ai.y+=this.ai.vy}else a=this.ai.y+this.ai.height/2,0>this.ball.vx?a<this.ctx.canvas.height/2-this.ctx.canvas.height/10?this.ai.y+=this.speed:a>this.ctx.canvas.height/2+this.ctx.canvas.height/10&&(this.ai.y-=this.speed):0<this.ball.vx&&2<Math.abs(this.ball.y-a)&&(this.ball.y<a?this.ai.y-=this.speed:this.ball.y>a&&(this.ai.y+=this.speed))};this.updateBall=function(){Math.abs(this.ball.x-
this.player.x)<Math.abs(this.ball.vx)&&(this.player.y<this.ball.y+0.1*this.player.height&&this.ball.y<this.player.y+1.1*this.player.height)&&(this.theta=(this.player.y+this.player.height/2-this.ball.y)/(this.player.height/2),this.ball.vx=this.ball.speed*Math.cos(this.theta),this.ball.vy=-this.ball.speed*Math.sin(this.theta));Math.abs(this.ball.x-this.ai.x)<Math.abs(this.ball.vx)&&(this.ai.y<this.ball.y+this.ai.height&&this.ball.y<this.ai.y+this.ai.height)&&(this.theta=(this.ai.y+this.ai.height/2-
this.ball.y)/(this.ai.height/2),this.ball.vx=-this.ball.speed*Math.cos(this.theta),this.ball.vy=this.ball.speed*Math.sin(this.theta));if(0>this.ball.y&&0>this.ball.vy||this.ball.y+this.ball.radius>this.ctx.canvas.height&&0<this.ball.vy)this.ball.vy=-this.ball.vy;if(0>this.ball.x&&0>this.ball.vx||this.ball.x>this.ctx.canvas.width&&0<this.ball.vx)if(this.ball.xo=this.ball.x,this.ball.yo=this.ball.y,this.ball.out=!0,this.ball.x=(this.ctx.canvas.width-this.ball.radius)/2,this.ball.y=this.ctx.canvas.height/
2,this.theta=2*Math.random()*Math.PI,this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4),this.theta>Math.PI+Math.PI/4&&this.theta<3*Math.PI/4+Math.PI&&(this.theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI),this.ball.vx=this.ball.speed*Math.cos(this.theta),this.ball.vy=this.ball.speed*Math.sin(this.theta),1===Math.round(Math.random()))this.ball.vy=-this.ball.vy;this.ball.x+=this.ball.vx;this.ball.y+=this.ball.vy};
this.distance=function(a,n){return Math.sqrt(Math.pow(n.x-a.x,2)+Math.pow(n.y-a.y,2))};this.update=function(){this.display?(this.updatePlayer(),this.updateAi(),this.updateBall()):(this.player.push=!0,this.ai.push=!0)};this.clear=function(){this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);this.ctx.restore()};this.drawRectangle=function(a,n,u,v,p){this.ctx.fillStyle=p instanceof Array?"rgb("+Math.floor(p[0])+","+Math.floor(p[1])+
","+Math.floor(p[2])+")":p;this.ctx.fillRect(a,n,u,v)};this.drawPlayer=function(a){this.drawRectangle(a.x,a.y,a.width,a.height,a.color)};this.drawBall=function(a){this.ctx.beginPath();this.ctx.lineWidth=0.5;this.ctx.fillStyle="black";this.ctx.strokeStyle="white";this.ctx.arc(a.x,a.y,a.radius,0,2*Math.PI,!1);this.ctx.fill();this.ctx.stroke()};this.render=function(){this.display&&(this.drawPlayer(this.player),this.drawPlayer(this.ai),this.drawBall(this.ball))};this.loop=function(){this.update();this.render()};
this.init=function(){var a=this.ctx.canvas.width/75,n=this.ctx.canvas.height/6,u=this.ctx.canvas.width,v=this.ctx.canvas.height;this.ai.width=a;this.ai.height=n;this.ai.x=u-this.ai.width;this.ai.y=v/2;this.player.width=a;this.player.height=n;this.player.y=v/2;this.ball.radius=2*a;this.theta=Math.PI;this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4);this.theta>Math.PI+Math.PI/4&&this.theta<3*Math.PI/4+Math.PI&&(this.theta=1===Math.round(Math.random())?
Math.PI/4+Math.PI:3*Math.PI/4+Math.PI);this.ball.vx=this.ball.speed*Math.cos(this.theta);this.ball.vy=this.ball.speed*Math.sin(this.theta);this.ball.x=this.ctx.canvas.width/2;this.ball.y=this.ctx.canvas.height/2};this.keyMap={left:{code:65,on:!1},up:{code:87,on:!1},right:{code:68,on:!1},down:{code:83,on:!1},left2:{code:74,on:!1},up2:{code:73,on:!1},right2:{code:76,on:!1},down2:{code:75,on:!1}}};var res,displaySize=512,fieldRes,clear_id,running=!1,canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),L=75,distanceRotators=[0,201,401];function multiplayer(){pong.ai.multiplayer=pong.ai.multiplayer?!1:!0;pong.ai.push=!0}function restart(){pong.clear();field.reset();pong.init();run_coul=!0;pong.display=!1}function rotator(a){if(0<=a&&200>=a)return[200-(100+a),100];if(200<a&&400>=a)return[-100+(a-200),100-(a-200)];if(400<a&&600>=a)return[100,-100+(a-400)]}var field,pong;
function explosion(){}var counter=0,suck_counter_1=100;
function prepareFrame(a){var c=rotator(distanceRotators[0]),n=rotator(distanceRotators[1]),u=rotator(distanceRotators[2]);pong.player.color=cielabToRGB(L,c[0],c[1],[0.9642,1,0.8249]);pong.ai.color=cielabToRGB(L,n[0],n[1],[0.9642,1,0.8249]);pong.ball.color=cielabToRGB(L,u[0],u[1],[0.9642,1,0.8249]);for(c=0;3>c;c++)distanceRotators[c]++,600<distanceRotators[c]&&(distanceRotators[c]=0);a.setDensityRGB(Math.floor(pong.ball.x+pong.ball.radius/2),Math.floor(pong.ball.y+pong.ball.radius/2),pong.ball.color);
pong.player.push&&(a.setVelocity(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),50,0),a.setDensityRGB(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),pong.player.color));if(pong.ball.out&&(pong.ball.xo>canvas.width/2?(c=canvas.width-1,n=-1):(n=1,c=0),a.setDensityRGB(c,Math.floor(pong.ball.yo+pong.ball.radius/2),pong.ball.color),a.setVelocity(c,Math.floor(pong.ball.yo+pong.ball.radius/2),1E3*n,0),counter++,12==
counter))pong.ball.out=!1,counter=0;pong.player.suck&&(c=pong.distance(pong.player,pong.ball),90<suck_counter_1&100>=suck_counter_1?(a.setVelocity(0,Math.floor(pong.player.y+pong.player.height/2),1E3,0),a.setDensityRGB(0,Math.floor(pong.player.y+pong.player.height/2),pong.player.color),c=100):0==suck_counter_1&&(suck_counter_1=100),20>c&&(pong.ball.x=pong.player.x+10+Math.random(),pong.ball.y=pong.player.y+pong.player.height/2+Math.random(),pong.ball.vx=0,pong.ball.vy=0),suck_counter_1--);pong.ai.push&&
(a.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-50,0),a.setDensityRGB(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),pong.ai.color));pong.ai.suck&&a.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-1E3,0);pong.ball.vy+=a.getYVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y));pong.ball.vx+=a.getXVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))}
function switchAnimation(){running?(running=!1,document.getElementById("switch").innerHTML="Unpause"):(running=!0,document.getElementById("switch").innerHTML="Pause")}var white=[0.9642,1,0.8249];function cielabToRGB(a,c,n,u){x=255*u[0]*inverseCielab(1/116*(a+16)+0.002*c);y=255*u[1]*inverseCielab(1/116*(a+16));z=255*u[2]*inverseCielab(1/116*(a+16)+0.005*n);return[x,y,z]}function inverseCielab(a){return a>6/29?Math.pow(a,3):3*Math.pow(6/29,2)*(a-4/29)}function startAnimation(){running=!0}
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();(function animloop(){requestAnimFrame(animloop);updateFrame()})();var filterStrength=20,frameTime=0,lastLoop=new Date,thisLoop,avg=Array(120),avg_index=0,avgs=0,avgs_index=0,benchmarking=!1;
function run_benchmark(){var a=(thisLoop=new Date)-lastLoop;frameTime+=(a-frameTime)/filterStrength;lastLoop=thisLoop;avg[avg_index]=1E3/frameTime;if(6<avg_index){for(var c=a=0;c<avg_index;c++)a+=avg[avg_index];1<avgs_index&&(60>avgs&&updateRes(24),benchmarking=!1);avgs+=a/avg_index;avgs_index++;avg_index=0}avg_index++}var coul=0,coul_incr=0,symbols=[3,2,1,"GO!"],coul_switch=!0,run_coul=!0;
function count_down(){coul++;60==coul&&(coul=0,coul_incr++);if(4==coul_incr)coul_incr=0,run_coul=!1,pong.clear(),field.reset(),pong.init(),pong.display=!0;else{var a=canvas.width/2-8,c=canvas.width/2+16;3==coul_incr&&(a-=16);ctx.font="bold 34px Arial";ctx.fillStyle="black";ctx.fillText(symbols[coul_incr],a-1,c+2);ctx.fillStyle="white";ctx.font="bold 32px Arial";ctx.fillText(symbols[coul_incr],a,c)}}
function updateFrame(){running&&(benchmarking&&run_benchmark(),field.update(),pong.loop(),run_coul&&count_down())}var r=96;function updateRes(a){canvas.width=a;fieldRes=canvas.height=a;field.setResolution(a,a);pong.init();pong.display=!1}
var keyDown=function(a){for(var c in pong.keyMap)if(pong.keyMap.hasOwnProperty(c)&&a.keyCode===pong.keyMap[c].code){pong.keyMap[c].on=!0;break}},keyUp=function(a){for(var c in pong.keyMap)if(pong.keyMap.hasOwnProperty(c)&&a.keyCode===pong.keyMap[c].code){pong.keyMap[c].on=!1;break}};
function begin(){field=new Fluid(canvas);field.setUICallback(prepareFrame);field.setDisplayFunction(field.toggleDisplayFunction(canvas,0));pong=new Pong(canvas);window.addEventListener("keydown",keyDown,!1);window.addEventListener("keyup",keyUp,!1);updateRes(r);startAnimation()}window.onload=begin;
