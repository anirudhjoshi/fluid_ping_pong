function FluidField(){function a(a,b,d){for(var f=0;f<u;f++)a[f]+=d*b[f]}function c(a,b){if(1===a){for(var d=1;d<=n;d++)b[d]=b[d+f],b[d+(o+1)*f]=b[d+o*f];for(var c=1;d<=o;d++)b[c*f]=-b[1+c*f],b[n+1+c*f]=-b[n+c*f]}else{if(2===a)for(d=1;d<=n;d++)b[d]=-b[d+f],b[d+(o+1)*f]=-b[d+o*f];else for(d=1;d<=n;d++)b[d]=b[d+f],b[d+(o+1)*f]=b[d+o*f];for(c=1;c<=o;c++)b[c*f]=b[1+c*f],b[n+1+c*f]=b[n+c*f]}d=(o+1)*f;b[0]=0.5*(b[1]+b[f]);b[d]=0.5*(b[1+d]+b[o*f]);b[n+1]=0.5*(b[n]+b[n+1+f]);b[n+1+d]=0.5*(b[n+d]+b[n+1+o*
f])}function i(a,b,d,I,l){if(0===I&&1===l){for(l=1;l<=o;l++){var e=l*f;++e;for(var s=0;s<n;s++)b[e]=d[e],++e}c(a,b)}else for(var q=1/l,w=0;w<g;w++){for(l=1;l<=o;l++){var h=(l-1)*f,e=l*f,i=(l+1)*f,k=b[e];++e;for(s=1;s<=n;s++)k=b[e]=(d[e]+I*(k+b[++e]+b[++h]+b[++i]))*q}c(a,b)}}function h(a){for(var b=0;b<u;b++)a[b]*=B}function p(a,b,d,I,l,e){for(var s=e*n,e=e*o,q=n+0.5,h=o+0.5,i=1;i<=o;i++)for(var k=i*f,m=1;m<=n;m++){var j=m-s*I[++k],g=i-e*l[k];0.5>j?j=0.5:j>q&&(j=q);var t=j|0,u=t+1;0.5>g?g=0.5:g>h&&
(g=h);var v=g|0,j=j-t,g=g-v,p=1-g,A=v*f,v=(v+1)*f;b[k]=(1-j)*(p*d[t+A]+g*d[t+v])+j*(p*d[u+A]+g*d[u+v])}c(a,b)}function C(a,b,d,q){for(var l=-0.5/Math.sqrt(n*o),e=1;e<=o;e++)for(var s=e*f,h=(e-1)*f,k=s-1,j=s,g=s+1,s=(e+1)*f,m=1;m<=n;m++)q[++j]=l*(a[++g]-a[++k]+b[++s]-b[++h]),d[j]=0;c(0,q);c(0,d);i(0,d,q,1,4);q=0.5*n;l=0.5*o;for(e=1;e<=o;e++){h=e*f-1;k=e*f;j=e*f+1;g=(e-1)*f;s=(e+1)*f;for(m=1;m<=n;m++)a[++k]-=q*(d[++j]-d[++h]),b[k]-=l*(d[++s]-d[++g])}c(1,a);c(2,b)}function q(a,b,d,c,q){this.setDensityRGB=
function(e,c,q){a[e+1+(c+1)*f]=q[0];b[e+1+(c+1)*f]=q[1];d[e+1+(c+1)*f]=q[2]};this.getDensityRGB=function(e,c){return[a[e+1+(c+1)*f],b[e+1+(c+1)*f],d[e+1+(c+1)*f]]};this.setVelocity=function(a,b,d,Q){c[a+1+(b+1)*f]=d;q[a+1+(b+1)*f]=Q};this.setVelocityInterp=function(a,b,d,c){var q=f;rI=a+2;rJ=b+2;i1=a+2;i2=0>rI-i1?a+3:a+1;j1=b+2;j2=0>rJ-j1?b+3:b+1;diffx=1-(rI-i1);diffy=1-(rJ-j1);vx1=d*diffx*diffy;vy1=c*diffy*diffx;vx2=d*(1-diffx)*diffy;vy2=c*diffy*(1-diffx);vx3=d*diffx*(1-diffy);vy3=c*(1-diffy)*diffx;
vx4=d*(1-diffx)*(1-diffy);vy4=c*(1-diffy)*(1-diffx);2>i1||(i1>f-1||2>j1||j1>q-1)||(this.setVelocity(i1,j1,vx1,vy1),this.setVelocity(i2,j1,vx2,vy2),this.setVelocity(i1,j2,vx3,vy3),this.setVelocity(i2,j2,vx4,vy4))};this.getXVelocity=function(a,b){return c[a+1+(b+1)*f]};this.getYVelocity=function(a,b){return q[a+1+(b+1)*f]};this.width=function(){return n};this.height=function(){return o}}function k(){f=n+2;u=(n+2)*(o+2);m=Array(u);j=Array(u);t=Array(u);D=Array(u);J=Array(u);K=Array(u);F=Array(u);G=Array(u);
H=Array(u);M=Array(u);for(var a=0;a<u;a++)G[a]=M[a]=F[a]=H[a]=0,m[a]=t[a]=J[a]=j[a]=D[a]=K[a]=0}var B=0.99,v=function(){};this.update=function(){for(var k=j,b=D,d=K,g=G,l=M,e=0;e<u;e++)g[e]=l[e]=k[e]=b[e]=d[e]=0;v(new q(k,b,d,g,l));k=F;b=H;d=G;g=M;l=A;a(k,d,l);a(b,g,l);for(var e=d,d=k,k=e,e=g,g=b,b=e,e=k,s=d,B=b,w=g,N=1;N<=o;N++){var E=N*f;++E;for(var O=0;O<n;O++)e[E]=s[E],B[E]=w[E],++E}c(1,e);c(2,B);C(k,b,d,g);e=d;d=k;k=e;e=g;g=b;b=e;p(1,k,d,d,g,l);p(2,b,g,d,g,l);C(k,b,d,g);G&&(k=j,b=D,d=K,g=m,l=
t,e=J,s=F,B=H,w=A,h(g),h(l),h(e),a(g,k,w),a(l,b,w),a(e,d,w),i(0,k,g,0,1),i(0,b,l,0,1),i(0,d,e,0,1),p(0,g,k,s,B,w),p(0,l,b,s,B,w),p(0,e,d,s,B,w));P(new q(m,t,J,F,H))};this.setDisplayFunction=function(a){P=a};this.iterations=function(){return g};this.setIterations=function(a){0<a&&100>=a&&(g=a)};this.setUICallback=function(a){v=a};var g=10,A=0.1,m,j,t,D,J,K,F,G,H,M,n,o,f,u,P;this.reset=k;this.setResolution=function(a,b){var d=b*a;return 0<d&&1E6>d&&(b!=n||a!=o)?(n=b,o=a,k(),!0):!1}};this.CanvasRenderingContext2D&&!CanvasRenderingContext2D.createImageData&&(CanvasRenderingContext2D.prototype.createImageData=function(a,c){return this.getImageData(0,0,a,c)});
(function(){function a(a){a:if(!i||!(i.width==a.width()&&i.height==a.height())){i=document.createElement("canvas");i.width=a.width();i.height=a.height();var c=i.getContext("2d");try{h=c.createImageData(a.width(),a.height())}catch(B){break a}if(h){for(var c=a.width()*a.height()*4,v=3;v<c;v=v+4)h.data[v]=255;h.data[0]=256;h.data[0]>255&&(p=true);h.data[0]=0}}var c=C.getContext("2d"),v=a.width(),g=a.height();ball.vy=ball.vy+a.getYVelocity(Math.round(ball.x),Math.round(ball.y))/7;ball.vx=ball.vx+a.getXVelocity(Math.round(ball.x),
Math.round(ball.y))/7;if(h){var A=h.data;if(p)for(var m=0;m<v;m++)for(var j=0;j<g;j++){var t=a.getDensity(m,j)*255/5,t=t|0;t>255&&(t=255);A[4*(j*g+m)+1]=t}else for(m=0;m<v;m++)for(j=0;j<g;j++){var t=4*(j*g+m),D=a.getDensityRGB(m,j);A[t+0]=Math.round(D[0]*255/5);A[t+1]=Math.round(D[1]*255/5);A[t+2]=Math.round(D[2]*255/5)}c.putImageData(h,0,0)}else for(m=0;m<v;m++)for(j=0;j<g;j++){t=a.getDensity(m,j)/5;c.setFillColor(0,t,0,1);c.fillRect(m,j,1,1)}}function c(a){var c=C.getContext("2d");c.save();c.lineWidth=
1;var h=C.width/a.width(),i=C.height/a.height();c.fillStyle="black";c.fillRect(0,0,C.width,C.height);c.strokeStyle="rgb(0,255,0)";c.beginPath();for(var g=0;g<a.width();g++)for(var p=0;p<a.height();p++){c.moveTo(g*h+0.5*h,p*i+0.5*i);c.lineTo((g+0.5+10*a.getXVelocity(g,p))*h,(p+0.5+10*a.getYVelocity(g,p))*i)}c.stroke();c.restore()}var i,h,p=false,C=document.getElementById("canvas");toggleDisplayFunction=function(h,i){if(i){h.width=displaySize;h.height=displaySize;return c}return a}})();var canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),theta,speed_increase=0.7,ball={x:0,y:0,xo:0,yo:0,out:!1,radius:0,speed:1,color:"red",vx:0,vy:0,ax:0.001,ay:0.001},ai={push:!0,suck:!1,stream:[0,0,0],multiplayer:!1,x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0},player={push:!1,suck:!1,explode:!1,stream:[0,0,0],x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0},speed=1;
function updatePlayer(){player.vy+=player.ay;keyMap.up.on&&(player.ay=-speed_increase,player.vy<-speed&&(player.vy=-speed));player.push=keyMap.right.on?!0:!1;player.suck=keyMap.left.on?!0:!1;keyMap.down.on&&(player.ay=speed_increase,player.vy>speed&&(player.vy=speed));if(!keyMap.down.on&&!keyMap.up.on||keyMap.down.on&&keyMap.up.on)player.ay=0,player.vy=0;if(0>player.y&&0>player.vy||player.y+player.height>ctx.canvas.height&&0<player.vy)player.ay=0,player.vy=0;player.y+=player.vy}
function distance(a,c){return Math.sqrt(Math.pow(c.x-a.x,2)+Math.pow(c.y-a.y,2))}
function updateAi(){if(ai.multiplayer){ai.vy+=ai.ay;keyMap.up2.on&&(ai.ay=-speed_increase,ai.vy<-speed&&(ai.vy=-speed));ai.push=keyMap.left2.on?!0:!1;ai.suck=keyMap.right2.on?!0:!1;keyMap.down2.on&&(ai.ay=speed_increase,ai.vy>speed&&(ai.vy=speed));if(!keyMap.down2.on&&!keyMap.up2.on||keyMap.down2.on&&keyMap.up2.on)ai.ay=0,ai.vy=0;if(0>ai.y&&0>ai.vy||ai.y+ai.height>ctx.canvas.height&&0<ai.vy)ai.ay=0,ai.vy=0;ai.y+=ai.vy}else real_y_pos=ai.y+ai.height/2,0>ball.vx?real_y_pos<ctx.canvas.height/2-ctx.canvas.height/
10?ai.y+=speed:real_y_pos>ctx.canvas.height/2+ctx.canvas.height/10&&(ai.y-=speed):0<ball.vx&&2<Math.abs(ball.y-real_y_pos)&&(ball.y<real_y_pos?ai.y-=speed:ball.y>real_y_pos&&(ai.y+=speed))}
function updateBall(){Math.abs(ball.x-player.x)<Math.abs(ball.vx)&&(player.y<ball.y+0.1*player.height&&ball.y<player.y+1.1*player.height)&&(theta=(player.y+player.height/2-ball.y)/(player.height/2),ball.vx=ball.speed*Math.cos(theta),ball.vy=-ball.speed*Math.sin(theta));Math.abs(ball.x-ai.x)<ball.vx&&(ball.y>ai.y&&ball.y<ai.y+ai.height)&&(theta=(ai.y+ai.height/2-ball.y)/(ai.height/2),ball.vx=-ball.speed*Math.cos(theta),ball.vy=ball.speed*Math.sin(theta));if(0>ball.y&&0>ball.vy||ball.y+ball.radius>
ctx.canvas.height&&0<ball.vy)ball.vy=-ball.vy;if(0>ball.x&&0>ball.vx||ball.x+ball.radius>ctx.canvas.width&&0<ball.vx)ball.xo=ball.x,ball.yo=ball.y,ball.out=!0,ball.x=(ctx.canvas.width-ball.radius)/2,ball.y=ctx.canvas.height/2,theta=2*Math.random()*Math.PI,theta>Math.PI/4&&theta<3*Math.PI/4&&(theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4),theta>Math.PI+Math.PI/4&&theta<3*Math.PI/4+Math.PI&&(theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI),ball.vx=ball.speed*Math.cos(theta),
ball.vy=ball.speed*Math.sin(theta),1===Math.round(Math.random())&&(ball.vy=-ball.vy);ball.vx+=ball.ax;ball.x+=ball.vx;ball.vy+=ball.ay;ball.y+=ball.vy}function update(){updatePlayer();updateAi();updateBall()}function clear(){ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.restore()}function drawRectangle(a,c,i,h,p){ctx.fillStyle=p instanceof Array?"rgb("+Math.floor(p[0])+","+Math.floor(p[1])+","+Math.floor(p[2])+")":p;ctx.fillRect(a,c,i,h)}
function drawPlayer(a){drawRectangle(a.x,a.y,a.width,a.height,a.color)}function drawBall(a){ctx.beginPath();ctx.lineWidth=0.5;ctx.fillStyle="black";ctx.strokeStyle="white";ctx.arc(a.x,a.y,a.radius,0,2*Math.PI,!1);ctx.fill();ctx.stroke()}function render(){drawPlayer(player);drawPlayer(ai);drawBall(ball)}function loop(){update();render()}
function init(){var a=ctx.canvas.width/75,c=ctx.canvas.height/6,i=ctx.canvas.width,h=ctx.canvas.height;ai.width=a;ai.height=c;ai.x=i-ai.width;ai.y=h/2;player.width=a;player.height=c;player.y=h/2;ball.radius=2*a;theta=Math.PI;theta>Math.PI/4&&theta<3*Math.PI/4&&(theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4);theta>Math.PI+Math.PI/4&&theta<3*Math.PI/4+Math.PI&&(theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI);ball.vx=ball.speed*Math.cos(theta);ball.vy=ball.speed*
Math.sin(theta);ball.x=ctx.canvas.width/2;ball.y=ctx.canvas.height/2}var keyMap={left:{code:65,on:!1},up:{code:87,on:!1},right:{code:68,on:!1},down:{code:83,on:!1},left2:{code:74,on:!1},up2:{code:73,on:!1},right2:{code:76,on:!1},down2:{code:75,on:!1}};window.addEventListener("keydown",function(a){for(var c in keyMap)if(a.keyCode===keyMap[c].code){keyMap[c].on=!0;break}},!1);window.addEventListener("keyup",function(a){for(var c in keyMap)if(a.keyCode===keyMap[c].code){keyMap[c].on=!1;break}},!1);var frames=0,force=5,source=100,sources=[],omx,omy,mx,my,mouseIsDown=!1,res,displaySize=512,fieldRes,clear_id,running=!1,canvas=document.getElementById("canvas"),L=75,distanceRotators=[0,201,401];function multiplayer(){ai.multiplayer=ai.multiplayer?!1:!0;ai.push=!0}function restart(){begin()}function rotator(a){if(0<=a&&200>=a)return[200-(100+a),100];if(200<a&&400>=a)return[-100+(a-200),100-(a-200)];if(400<a&&600>=a)return[100,-100+(a-400)]}var field;function explosion(){}
var counter=0,suck_counter_1=100;
function prepareFrame(a){var c=rotator(distanceRotators[0]),i=rotator(distanceRotators[1]),h=rotator(distanceRotators[2]);player.color=cielabToRGB(L,c[0],c[1],[0.9642,1,0.8249]);ai.color=cielabToRGB(L,i[0],i[1],[0.9642,1,0.8249]);ball.color=cielabToRGB(L,h[0],h[1],[0.9642,1,0.8249]);for(c=0;3>c;c++)distanceRotators[c]++,600<distanceRotators[c]&&(distanceRotators[c]=0);a.setDensityRGB(Math.floor(ball.x+ball.radius/2),Math.floor(ball.y+ball.radius/2),ball.color);player.push&&(a.setVelocity(Math.floor(player.x+
player.width/2),Math.floor(player.y+player.height/2),50,0),a.setDensityRGB(Math.floor(player.x+player.width/2),Math.floor(player.y+player.height/2),player.color));if(ball.out&&(ball.xo>canvas.width/2?(c=canvas.width-1,i=-1):(i=1,c=0),a.setDensityRGB(c,Math.floor(ball.yo+ball.radius/2),ball.color),a.setVelocity(c,Math.floor(ball.yo+ball.radius/2),1E3*i,0),counter++,12==counter))ball.out=!1,counter=0;player.suck&&(c=distance(player,ball),90<suck_counter_1&100>=suck_counter_1?(a.setVelocity(0,Math.floor(player.y+
player.height/2),1E3,0),a.setDensityRGB(0,Math.floor(player.y+player.height/2),player.color),c=100):0==suck_counter_1&&(suck_counter_1=100),20>c&&(ball.x=player.x+10+Math.random(),ball.y=player.y+player.height/2+Math.random(),ball.vx=0,ball.vy=0),console.log(suck_counter_1),suck_counter_1--);ai.push&&(a.setVelocity(Math.floor(ai.x+ai.width/2),Math.floor(ai.y+ai.height/2),-50,0),a.setDensityRGB(Math.floor(ai.x+ai.width/2),Math.floor(ai.y+ai.height/2),ai.color));ai.suck&&a.setVelocity(Math.floor(ai.x+
ai.width/2),Math.floor(ai.y+ai.height/2),-1E3,0)}function switchAnimation(){running?(running=!1,document.getElementById("switch").innerHTML="Unpause"):(running=!0,document.getElementById("switch").innerHTML="Pause")}var white=[0.9642,1,0.8249];function cielabToRGB(a,c,i,h){x=255*h[0]*inverseCielab(1/116*(a+16)+0.002*c);y=255*h[1]*inverseCielab(1/116*(a+16));z=255*h[2]*inverseCielab(1/116*(a+16)+0.005*i);return[x,y,z]}
function inverseCielab(a){return a>6/29?Math.pow(a,3):3*Math.pow(6/29,2)*(a-4/29)}function startAnimation(){running=!0}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();(function animloop(){requestAnimFrame(animloop);updateFrame()})();var filterStrength=20,frameTime=0,lastLoop=new Date,thisLoop;
function updateFrame(){if(running){var a=(thisLoop=new Date)-lastLoop;frameTime+=(a-frameTime)/filterStrength;lastLoop=thisLoop;console.log(1E3/frameTime);field.update();loop()}}var r=96;function begin(){field=new FluidField(canvas);field.setUICallback(prepareFrame);field.setDisplayFunction(toggleDisplayFunction(canvas,0));updateRes=function(){canvas.width=r;fieldRes=canvas.height=r;field.setResolution(r,r);init();loop()};updateRes();startAnimation()}window.onload=begin;
