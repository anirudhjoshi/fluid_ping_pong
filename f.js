this.CanvasRenderingContext2D&&!CanvasRenderingContext2D.createImageData&&(CanvasRenderingContext2D.prototype.createImageData=function(a,c){return this.getImageData(0,0,a,c)});
function FluidField(){function a(c,b,d){for(var a=0;a<u;a++)c[a]=c[a]+d*b[a]}function c(c,b){if(c===1){for(var d=1;d<=n;d++){b[d]=b[d+f];b[d+(p+1)*f]=b[d+p*f]}for(var a=1;d<=p;d++){b[a*f]=-b[1+a*f];b[n+1+a*f]=-b[n+a*f]}}else{if(c===2)for(d=1;d<=n;d++){b[d]=-b[d+f];b[d+(p+1)*f]=-b[d+p*f]}else for(d=1;d<=n;d++){b[d]=b[d+f];b[d+(p+1)*f]=b[d+p*f]}for(a=1;a<=p;a++){b[a*f]=b[1+a*f];b[n+1+a*f]=b[n+a*f]}}d=(p+1)*f;b[0]=0.5*(b[1]+b[f]);b[d]=0.5*(b[1+d]+b[p*f]);b[n+1]=0.5*(b[n]+b[n+1+f]);b[n+1+d]=0.5*(b[n+
d]+b[n+1+p*f])}function i(a,b,d,I,l){if(I===0&&l===1){for(l=1;l<=p;l++){var e=l*f;++e;for(var s=0;s<n;s++){b[e]=d[e];++e}}c(a,b)}else for(var o=1/l,i=0;i<g;i++){for(l=1;l<=p;l++){var h=(l-1)*f,e=l*f,m=(l+1)*f,k=b[e];++e;for(s=1;s<=n;s++)k=b[e]=(d[e]+I*(k+b[++e]+b[++h]+b[++m]))*o}c(a,b)}}function h(a){for(var b=0;b<u;b++)a[b]=a[b]*B}function A(a,b,d,I,l,e){for(var s=e*n,e=e*p,o=n+0.5,i=p+0.5,h=1;h<=p;h++)for(var m=h*f,k=1;k<=n;k++){var j=k-s*I[++m],g=h-e*l[m];j<0.5?j=0.5:j>o&&(j=o);var t=j|0,u=t+1;
g<0.5?g=0.5:g>i&&(g=i);var q=g|0,j=j-t,g=g-q,w=1-g,v=q*f,q=(q+1)*f;b[m]=(1-j)*(w*d[t+v]+g*d[t+q])+j*(w*d[u+v]+g*d[u+q])}c(a,b)}function q(a,b,d,o){for(var l=-0.5/Math.sqrt(n*p),e=1;e<=p;e++)for(var s=e*f,h=(e-1)*f,m=s-1,j=s,g=s+1,s=(e+1)*f,k=1;k<=n;k++){o[++j]=l*(a[++g]-a[++m]+b[++s]-b[++h]);d[j]=0}c(0,o);c(0,d);i(0,d,o,1,4);o=0.5*n;l=0.5*p;for(e=1;e<=p;e++){h=e*f-1;m=e*f;j=e*f+1;g=(e-1)*f;s=(e+1)*f;for(k=1;k<=n;k++){a[++m]-=o*(d[++j]-d[++h]);b[m]=b[m]-l*(d[++s]-d[++g])}}c(1,a);c(2,b)}function o(a,
b,c,o,h){this.setDensityRGB=function(e,o,h){a[e+1+(o+1)*f]=h[0];b[e+1+(o+1)*f]=h[1];c[e+1+(o+1)*f]=h[2]};this.getDensityRGB=function(e,o){return[a[e+1+(o+1)*f],b[e+1+(o+1)*f],c[e+1+(o+1)*f]]};this.setVelocity=function(a,b,c,d){o[a+1+(b+1)*f]=c;h[a+1+(b+1)*f]=d};this.setVelocityInterp=function(a,b,c,d){var o=f;rI=a+2;rJ=b+2;i1=a+2;i2=rI-i1<0?a+3:a+1;j1=b+2;j2=rJ-j1<0?b+3:b+1;diffx=1-(rI-i1);diffy=1-(rJ-j1);vx1=c*diffx*diffy;vy1=d*diffy*diffx;vx2=c*(1-diffx)*diffy;vy2=d*diffy*(1-diffx);vx3=c*diffx*
(1-diffy);vy3=d*(1-diffy)*diffx;vx4=c*(1-diffx)*(1-diffy);vy4=d*(1-diffy)*(1-diffx);if(!(i1<2||i1>f-1||j1<2||j1>o-1)){this.setVelocity(i1,j1,vx1,vy1);this.setVelocity(i2,j1,vx2,vy2);this.setVelocity(i1,j2,vx3,vy3);this.setVelocity(i2,j2,vx4,vy4)}};this.getXVelocity=function(a,b){return o[a+1+(b+1)*f]};this.getYVelocity=function(a,b){return h[a+1+(b+1)*f]};this.width=function(){return n};this.height=function(){return p}}function m(){f=n+2;u=(n+2)*(p+2);k=Array(u);j=Array(u);t=Array(u);D=Array(u);J=
Array(u);K=Array(u);F=Array(u);G=Array(u);H=Array(u);M=Array(u);for(var a=0;a<u;a++){G[a]=M[a]=F[a]=H[a]=0;k[a]=t[a]=J[a]=j[a]=D[a]=K[a]=0}}var B=0.99,w=function(){};this.update=function(){for(var m=j,b=D,d=K,g=G,l=M,e=0;e<u;e++)g[e]=l[e]=m[e]=b[e]=d[e]=0;w(new o(m,b,d,g,l));m=F;b=H;d=G;g=M;l=v;a(m,d,l);a(b,g,l);for(var e=d,d=m,m=e,e=g,g=b,b=e,e=m,s=d,B=b,C=g,N=1;N<=p;N++){var E=N*f;++E;for(var O=0;O<n;O++){e[E]=s[E];B[E]=C[E];++E}}c(1,e);c(2,B);q(m,b,d,g);e=d;d=m;m=e;e=g;g=b;b=e;A(1,m,d,d,g,l);A(2,
b,g,d,g,l);q(m,b,d,g);if(G){m=j;b=D;d=K;g=k;l=t;e=J;s=F;B=H;C=v;h(g);h(l);h(e);a(g,m,C);a(l,b,C);a(e,d,C);i(0,m,g,0,1);i(0,b,l,0,1);i(0,d,e,0,1);A(0,g,m,s,B,C);A(0,l,b,s,B,C);A(0,e,d,s,B,C)}P(new o(k,t,J,F,H))};this.setDisplayFunction=function(a){P=a};this.iterations=function(){return g};this.setIterations=function(a){a>0&&a<=100&&(g=a)};this.setUICallback=function(a){w=a};var g=10,v=0.1,k,j,t,D,J,K,F,G,H,M,n,p,f,u,P;this.reset=m;this.setResolution=function(a,b){var c=b*a;if(c>0&&c<1E6&&(b!=n||a!=
p)){n=b;p=a;m();return true}return false};this.buffer=null}
(function(){function a(a){a:if(!i||!(i.width==a.width()&&i.height==a.height())){i=document.createElement("canvas");i.width=a.width();i.height=a.height();var c=i.getContext("2d");try{h=c.createImageData(a.width(),a.height())}catch(B){break a}if(h){for(var c=a.width()*a.height()*4,w=3;w<c;w=w+4)h.data[w]=255;h.data[0]=256;h.data[0]>255&&(A=true);h.data[0]=0}}var c=q.getContext("2d"),w=a.width(),g=a.height();pong.ball.vy=pong.ball.vy+a.getYVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/7;
pong.ball.vx=pong.ball.vx+a.getXVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/7;if(h){var v=h.data;if(A)for(var k=0;k<w;k++)for(var j=0;j<g;j++){var t=a.getDensity(k,j)*255/5,t=t|0;t>255&&(t=255);v[4*(j*g+k)+1]=t}else for(k=0;k<w;k++)for(j=0;j<g;j++){var t=4*(j*g+k),D=a.getDensityRGB(k,j);v[t+0]=Math.round(D[0]*255/5);v[t+1]=Math.round(D[1]*255/5);v[t+2]=Math.round(D[2]*255/5)}c.putImageData(h,0,0)}else for(k=0;k<w;k++)for(j=0;j<g;j++){t=a.getDensity(k,j)/5;c.setFillColor(0,t,0,1);c.fillRect(k,
j,1,1)}}function c(a){var c=q.getContext("2d");c.save();c.lineWidth=1;var h=q.width/a.width(),i=q.height/a.height();c.fillStyle="black";c.fillRect(0,0,q.width,q.height);c.strokeStyle="rgb(0,255,0)";c.beginPath();for(var g=0;g<a.width();g++)for(var v=0;v<a.height();v++){c.moveTo(g*h+0.5*h,v*i+0.5*i);c.lineTo((g+0.5+10*a.getXVelocity(g,v))*h,(v+0.5+10*a.getYVelocity(g,v))*i)}c.stroke();c.restore()}var i,h,A=false,q=document.getElementById("canvas");toggleDisplayFunction=function(h,i){if(i){h.width=
displaySize;h.height=displaySize;return c}h.width=fieldRes;h.height=fieldRes;return a}})();function Pong(a){this.canvas=a;this.ctx=this.canvas.getContext("2d");this.theta=0;this.speed_increase=0.7;this.speed=1;this.ball={x:0,y:0,xo:0,yo:0,out:!1,radius:0,speed:1,color:"red",vx:0,vy:0,ax:0.001,ay:0.001};this.ai={push:!0,suck:!1,stream:[0,0,0],multiplayer:!1,x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.player={push:!1,suck:!1,explode:!1,stream:[0,0,0],x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.updatePlayer=function(){this.keyMap.up.on&&(this.player.ay=
-this.speed_increase,this.player.vy<-this.speed&&(this.player.vy=-this.speed));this.player.push=this.keyMap.right.on?!0:!1;this.player.suck=this.keyMap.left.on?!0:!1;this.keyMap.down.on&&(this.player.ay=this.speed_increase,this.player.vy>this.speed&&(this.player.vy=this.speed));if(!this.keyMap.down.on&&!this.keyMap.up.on||this.keyMap.down.on&&this.keyMap.up.on)this.player.ay=0,this.player.vy=0;if(0>this.player.y&&0>this.player.vy||this.player.y+this.player.height>this.ctx.canvas.height&&0<this.player.vy)this.player.ay=
0,this.player.vy=0;this.player.vy+=this.player.ay;this.player.y+=this.player.vy};this.updateAi=function(){var a=0;if(this.ai.multiplayer){this.ai.vy+=this.ai.ay;this.keyMap.up2.on&&(this.ai.ay=-this.speed_increase,this.ai.vy<-this.speed&&(this.ai.vy=-this.speed));this.ai.push=this.keyMap.left2.on?!0:!1;this.ai.suck=this.keyMap.right2.on?!0:!1;this.keyMap.down2.on&&(this.ai.ay=this.speed_increase,this.ai.vy>this.speed&&(this.ai.vy=this.speed));if(!this.keyMap.down2.on&&!this.keyMap.up2.on||this.keyMap.down2.on&&
this.keyMap.up2.on)this.ai.ay=0,this.ai.vy=0;if(0>this.ai.y&&0>this.ai.vy||this.ai.y+this.ai.height>this.ctx.canvas.height&&0<this.ai.vy)this.ai.ay=0,this.ai.vy=0;this.ai.y+=this.ai.vy}else a=this.ai.y+this.ai.height/2,0>this.ball.vx?a<this.ctx.canvas.height/2-this.ctx.canvas.height/10?this.ai.y+=this.speed:a>this.ctx.canvas.height/2+this.ctx.canvas.height/10&&(this.ai.y-=this.speed):0<this.ball.vx&&2<Math.abs(this.ball.y-a)&&(this.ball.y<a?this.ai.y-=this.speed:this.ball.y>a&&(this.ai.y+=this.speed))};
this.updateBall=function(){Math.abs(this.ball.x-this.player.x)<Math.abs(this.ball.vx)&&(this.player.y<this.ball.y+0.1*this.player.height&&this.ball.y<this.player.y+1.1*this.player.height)&&(this.theta=(this.player.y+this.player.height/2-this.ball.y)/(this.player.height/2),this.ball.vx=this.ball.speed*Math.cos(this.theta),this.ball.vy=-this.ball.speed*Math.sin(this.theta));Math.abs(this.ball.x-this.ai.x)<this.ball.vx&&(this.ball.y>this.ai.y&&this.ball.y<this.ai.y+this.ai.height)&&(this.theta=(this.ai.y+
this.ai.height/2-this.ball.y)/(this.ai.height/2),this.ball.vx=-this.ball.speed*Math.cos(this.theta),this.ball.vy=this.ball.speed*Math.sin(this.theta));if(0>this.ball.y&&0>this.ball.vy||this.ball.y+this.ball.radius>this.ctx.canvas.height&&0<this.ball.vy)this.ball.vy=-this.ball.vy;if(0>this.ball.x&&0>this.ball.vx||this.ball.x+this.ball.radius>this.ctx.canvas.width&&0<this.ball.vx)if(this.ball.xo=this.ball.x,this.ball.yo=this.ball.y,this.ball.out=!0,this.ball.x=(this.ctx.canvas.width-this.ball.radius)/
2,this.ball.y=this.ctx.canvas.height/2,this.theta=2*Math.random()*Math.PI,this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4),this.theta>Math.PI+Math.PI/4&&this.theta<3*Math.PI/4+Math.PI&&(this.theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI),this.ball.vx=this.ball.speed*Math.cos(this.theta),this.ball.vy=this.ball.speed*Math.sin(this.theta),1===Math.round(Math.random()))this.ball.vy=-this.ball.vy;this.ball.vx+=this.ball.ax;
this.ball.x+=this.ball.vx;this.ball.vy+=this.ball.ay;this.ball.y+=this.ball.vy};this.distance=function(a,i){return Math.sqrt(Math.pow(i.x-a.x,2)+Math.pow(i.y-a.y,2))};this.update=function(){this.updatePlayer();this.updateAi();this.updateBall()};this.clear=function(){this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);this.ctx.restore()};this.drawRectangle=function(a,i,h,A,q){this.ctx.fillStyle=q instanceof Array?"rgb("+Math.floor(q[0])+
","+Math.floor(q[1])+","+Math.floor(q[2])+")":q;this.ctx.fillRect(a,i,h,A)};this.drawPlayer=function(a){this.drawRectangle(a.x,a.y,a.width,a.height,a.color)};this.drawBall=function(a){this.ctx.beginPath();this.ctx.lineWidth=0.5;this.ctx.fillStyle="black";this.ctx.strokeStyle="white";this.ctx.arc(a.x,a.y,a.radius,0,2*Math.PI,!1);this.ctx.fill();this.ctx.stroke()};this.render=function(){this.drawPlayer(this.player);this.drawPlayer(this.ai);this.drawBall(this.ball)};this.loop=function(){this.update();
this.render()};this.init=function(){var a=this.ctx.canvas.width/75,i=this.ctx.canvas.height/6,h=this.ctx.canvas.width,A=this.ctx.canvas.height;this.ai.width=a;this.ai.height=i;this.ai.x=h-this.ai.width;this.ai.y=A/2;this.player.width=a;this.player.height=i;this.player.y=A/2;this.ball.radius=2*a;this.theta=Math.PI;this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4);this.theta>Math.PI+Math.PI/4&&this.theta<3*Math.PI/4+Math.PI&&(this.theta=1===
Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI);this.ball.vx=this.ball.speed*Math.cos(this.theta);this.ball.vy=this.ball.speed*Math.sin(this.theta);this.ball.x=this.ctx.canvas.width/2;this.ball.y=this.ctx.canvas.height/2};this.keyMap={left:{code:65,on:!1},up:{code:87,on:!1},right:{code:68,on:!1},down:{code:83,on:!1},left2:{code:74,on:!1},up2:{code:73,on:!1},right2:{code:76,on:!1},down2:{code:75,on:!1}}};var res,displaySize=512,fieldRes,clear_id,running=!1,canvas=document.getElementById("canvas"),L=75,distanceRotators=[0,201,401];function multiplayer(){pong.ai.multiplayer=pong.ai.multiplayer?!1:!0;pong.ai.push=!0}function restart(){begin()}function rotator(a){if(0<=a&&200>=a)return[200-(100+a),100];if(200<a&&400>=a)return[-100+(a-200),100-(a-200)];if(400<a&&600>=a)return[100,-100+(a-400)]}var field,pong;function explosion(){}var counter=0,suck_counter_1=100;
function prepareFrame(a){var c=rotator(distanceRotators[0]),i=rotator(distanceRotators[1]),h=rotator(distanceRotators[2]);pong.player.color=cielabToRGB(L,c[0],c[1],[0.9642,1,0.8249]);pong.ai.color=cielabToRGB(L,i[0],i[1],[0.9642,1,0.8249]);pong.ball.color=cielabToRGB(L,h[0],h[1],[0.9642,1,0.8249]);for(c=0;3>c;c++)distanceRotators[c]++,600<distanceRotators[c]&&(distanceRotators[c]=0);a.setDensityRGB(Math.floor(pong.ball.x+pong.ball.radius/2),Math.floor(pong.ball.y+pong.ball.radius/2),pong.ball.color);
pong.player.push&&(a.setVelocity(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),50,0),a.setDensityRGB(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),pong.player.color));if(pong.ball.out&&(pong.ball.xo>canvas.width/2?(c=canvas.width-1,i=-1):(i=1,c=0),a.setDensityRGB(c,Math.floor(pong.ball.yo+pong.ball.radius/2),pong.ball.color),a.setVelocity(c,Math.floor(pong.ball.yo+pong.ball.radius/2),1E3*i,0),counter++,12==
counter))pong.ball.out=!1,counter=0;pong.player.suck&&(c=pong.distance(pong.player,pong.ball),90<suck_counter_1&100>=suck_counter_1?(a.setVelocity(0,Math.floor(pong.player.y+pong.player.height/2),1E3,0),a.setDensityRGB(0,Math.floor(pong.player.y+pong.player.height/2),pong.player.color),c=100):0==suck_counter_1&&(suck_counter_1=100),20>c&&(pong.ball.x=pong.player.x+10+Math.random(),pong.ball.y=pong.player.y+pong.player.height/2+Math.random(),pong.ball.vx=0,pong.ball.vy=0),console.log(suck_counter_1),
suck_counter_1--);pong.ai.push&&(a.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-50,0),a.setDensityRGB(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),pong.ai.color));pong.ai.suck&&a.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-1E3,0)}
function switchAnimation(){running?(running=!1,document.getElementById("switch").innerHTML="Unpause"):(running=!0,document.getElementById("switch").innerHTML="Pause")}var white=[0.9642,1,0.8249];function cielabToRGB(a,c,i,h){x=255*h[0]*inverseCielab(1/116*(a+16)+0.002*c);y=255*h[1]*inverseCielab(1/116*(a+16));z=255*h[2]*inverseCielab(1/116*(a+16)+0.005*i);return[x,y,z]}function inverseCielab(a){return a>6/29?Math.pow(a,3):3*Math.pow(6/29,2)*(a-4/29)}function startAnimation(){running=!0}
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();(function animloop(){requestAnimFrame(animloop);updateFrame()})();var filterStrength=20,frameTime=0,lastLoop=new Date,thisLoop,avg=Array(120),avg_index=0,avgs=0,avgs_index=0,benchmarking=!0;
function run_benchmark(){var a=(thisLoop=new Date)-lastLoop;frameTime+=(a-frameTime)/filterStrength;lastLoop=thisLoop;avg[avg_index]=1E3/frameTime;if(6<avg_index){for(var c=a=0;c<avg_index;c++)a+=avg[avg_index];console.log(a/avg_index,avg_index);1<avgs_index&&(60>avgs&&updateRes(24),benchmarking=!1);avgs+=a/avg_index;avgs_index++;avg_index=0}avg_index++}function updateFrame(){running&&(benchmarking&&run_benchmark(),field.update(),pong.loop())}var r=96;
function updateRes(a){canvas.width=a;fieldRes=canvas.height=a;field.setResolution(a,a);pong.init();pong.loop()}var keyDown=function(a){for(var c in pong.keyMap)if(pong.keyMap.hasOwnProperty(c)&&a.keyCode===pong.keyMap[c].code){pong.keyMap[c].on=!0;break}},keyUp=function(a){for(var c in pong.keyMap)if(pong.keyMap.hasOwnProperty(c)&&a.keyCode===pong.keyMap[c].code){pong.keyMap[c].on=!1;break}};
function begin(){field=new FluidField(canvas);field.setUICallback(prepareFrame);field.setDisplayFunction(toggleDisplayFunction(canvas,0));pong=new Pong(canvas);window.addEventListener("keydown",keyDown,!1);window.addEventListener("keyup",keyUp,!1);updateRes(r);startAnimation()}window.onload=begin;
