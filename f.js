this.CanvasRenderingContext2D&&!CanvasRenderingContext2D.createImageData&&(CanvasRenderingContext2D.prototype.createImageData=function(b,a){return this.getImageData(0,0,b,a)});
function FluidField(){function b(a,d,e){for(var b=0;b<t;b++)a[b]=a[b]+e*d[b]}function a(a,d){if(a===1){for(var e=1;e<=n;e++){d[e]=d[e+h];d[e+(p+1)*h]=d[e+p*h]}for(var b=1;e<=p;e++){d[b*h]=-d[1+b*h];d[n+1+b*h]=-d[n+b*h]}}else{if(a===2)for(e=1;e<=n;e++){d[e]=-d[e+h];d[e+(p+1)*h]=-d[e+p*h]}else for(e=1;e<=n;e++){d[e]=d[e+h];d[e+(p+1)*h]=d[e+p*h]}for(b=1;b<=p;b++){d[b*h]=d[1+b*h];d[n+1+b*h]=d[n+b*h]}}e=(p+1)*h;d[0]=0.5*(d[1]+d[h]);d[e]=0.5*(d[1+e]+d[p*h]);d[n+1]=0.5*(d[n]+d[n+1+h]);d[n+1+e]=0.5*(d[n+
e]+d[n+1+p*h])}function j(b,d,e,j,c){if(j===0&&c===1){for(c=1;c<=p;c++){var f=c*h;++f;for(var q=0;q<n;q++){d[f]=e[f];++f}}a(b,d)}else for(var v=1/c,i=0;i<g;i++){for(c=1;c<=p;c++){var l=(c-1)*h,f=c*h,k=(c+1)*h,o=d[f];++f;for(q=1;q<=n;q++)o=d[f]=(e[f]+j*(o+d[++f]+d[++l]+d[++k]))*v}a(b,d)}}function c(a){for(var d=0;d<t;d++)a[d]=a[d]*C}function i(b,d,e,c,j,f){for(var q=f*n,f=f*p,v=n+0.5,i=p+0.5,l=1;l<=p;l++)for(var k=l*h,o=1;o<=n;o++){var m=o-q*c[++k],g=l-f*j[k];m<0.5?m=0.5:m>v&&(m=v);var s=m|0,t=s+1;
g<0.5?g=0.5:g>i&&(g=i);var u=g|0,m=m-s,g=g-u,B=1-g,A=u*h,u=(u+1)*h;d[k]=(1-m)*(B*e[s+A]+g*e[s+u])+m*(B*e[t+A]+g*e[t+u])}a(b,d)}function k(b,d,e,c){for(var v=-0.5/Math.sqrt(n*p),f=1;f<=p;f++)for(var q=f*h,l=(f-1)*h,i=q-1,k=q,m=q+1,q=(f+1)*h,g=1;g<=n;g++){c[++k]=v*(b[++m]-b[++i]+d[++q]-d[++l]);e[k]=0}a(0,c);a(0,e);j(0,e,c,1,4);c=0.5*n;v=0.5*p;for(f=1;f<=p;f++){l=f*h-1;i=f*h;k=f*h+1;m=(f-1)*h;q=(f+1)*h;for(g=1;g<=n;g++){b[++i]-=c*(e[++k]-e[++l]);d[i]=d[i]-v*(e[++q]-e[++m])}}a(1,b);a(2,d)}function v(a,
b,e,c,j){this.setDensityRGB=function(f,c,j){a[f+1+(c+1)*h]=j[0];b[f+1+(c+1)*h]=j[1];e[f+1+(c+1)*h]=j[2]};this.getDensityRGB=function(f,c){return[a[f+1+(c+1)*h],b[f+1+(c+1)*h],e[f+1+(c+1)*h]]};this.setVelocity=function(a,b,d,e){c[a+1+(b+1)*h]=d;j[a+1+(b+1)*h]=e};this.setVelocityInterp=function(a,b,d,c){var e=h;rI=a+2;rJ=b+2;i1=a+2;i2=rI-i1<0?a+3:a+1;j1=b+2;j2=rJ-j1<0?b+3:b+1;diffx=1-(rI-i1);diffy=1-(rJ-j1);vx1=d*diffx*diffy;vy1=c*diffy*diffx;vx2=d*(1-diffx)*diffy;vy2=c*diffy*(1-diffx);vx3=d*diffx*
(1-diffy);vy3=c*(1-diffy)*diffx;vx4=d*(1-diffx)*(1-diffy);vy4=c*(1-diffy)*(1-diffx);if(!(i1<2||i1>h-1||j1<2||j1>e-1)){this.setVelocity(i1,j1,vx1,vy1);this.setVelocity(i2,j1,vx2,vy2);this.setVelocity(i1,j2,vx3,vy3);this.setVelocity(i2,j2,vx4,vy4)}};this.getXVelocity=function(a,b){return c[a+1+(b+1)*h]};this.getYVelocity=function(a,b){return j[a+1+(b+1)*h]};this.width=function(){return n};this.height=function(){return p}}function l(){h=n+2;t=(n+2)*(p+2);o=Array(t);m=Array(t);s=Array(t);A=Array(t);I=
Array(t);J=Array(t);F=Array(t);G=Array(t);H=Array(t);K=Array(t);for(var a=0;a<t;a++){G[a]=K[a]=F[a]=H[a]=0;o[a]=s[a]=I[a]=m[a]=A[a]=J[a]=0}}var C=0.99,u=function(){};this.update=function(){for(var l=m,d=A,e=J,g=G,w=K,f=0;f<t;f++)g[f]=w[f]=l[f]=d[f]=e[f]=0;u(new v(l,d,e,g,w));l=F;d=H;e=G;g=K;w=B;b(l,e,w);b(d,g,w);for(var f=e,e=l,l=f,f=g,g=d,d=f,f=l,q=e,C=d,D=g,M=1;M<=p;M++){var E=M*h;++E;for(var N=0;N<n;N++){f[E]=q[E];C[E]=D[E];++E}}a(1,f);a(2,C);k(l,d,e,g);f=e;e=l;l=f;f=g;g=d;d=f;i(1,l,e,e,g,w);i(2,
d,g,e,g,w);k(l,d,e,g);if(G){l=m;d=A;e=J;g=o;w=s;f=I;q=F;C=H;D=B;c(g);c(w);c(f);b(g,l,D);b(w,d,D);b(f,e,D);j(0,l,g,0,1);j(0,d,w,0,1);j(0,e,f,0,1);i(0,g,l,q,C,D);i(0,w,d,q,C,D);i(0,f,e,q,C,D)}O(new v(o,s,I,F,H))};this.setDisplayFunction=function(a){O=a};this.iterations=function(){return g};this.setIterations=function(a){a>0&&a<=100&&(g=a)};this.setUICallback=function(a){u=a};var g=10,B=0.1,o,m,s,A,I,J,F,G,H,K,n,p,h,t,O;this.reset=l;this.setResolution=function(a,b){var c=b*a;if(c>0&&c<1E6&&(b!=n||a!=
p)){n=b;p=a;l();return true}return false};this.buffer=null}
(function(){function b(a){a:if(!j||!(j.width==a.width()&&j.height==a.height())){j=document.createElement("canvas");j.width=a.width();j.height=a.height();var b=j.getContext("2d");try{c=b.createImageData(a.width(),a.height())}catch(C){break a}if(c){for(var b=a.width()*a.height()*4,u=3;u<b;u=u+4)c.data[u]=255;c.data[0]=256;c.data[0]>255&&(i=true);c.data[0]=0}}var b=k.getContext("2d"),u=a.width(),g=a.height();pong.ball.vy=pong.ball.vy+a.getYVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/7;
pong.ball.vx=pong.ball.vx+a.getXVelocity(Math.round(pong.ball.x),Math.round(pong.ball.y))/7;if(c){var B=c.data;if(i)for(var o=0;o<u;o++)for(var m=0;m<g;m++){var s=a.getDensity(o,m)*255/5,s=s|0;s>255&&(s=255);B[4*(m*g+o)+1]=s}else for(o=0;o<u;o++)for(m=0;m<g;m++){var s=4*(m*g+o),A=a.getDensityRGB(o,m);B[s+0]=Math.round(A[0]*255/5);B[s+1]=Math.round(A[1]*255/5);B[s+2]=Math.round(A[2]*255/5)}b.putImageData(c,0,0)}else for(o=0;o<u;o++)for(m=0;m<g;m++){s=a.getDensity(o,m)/5;b.setFillColor(0,s,0,1);b.fillRect(o,
m,1,1)}}function a(a){var b=k.getContext("2d");b.save();b.lineWidth=1;var c=k.width/a.width(),j=k.height/a.height();b.fillStyle="black";b.fillRect(0,0,k.width,k.height);b.strokeStyle="rgb(0,255,0)";b.beginPath();for(var g=0;g<a.width();g++)for(var i=0;i<a.height();i++){b.moveTo(g*c+0.5*c,i*j+0.5*j);b.lineTo((g+0.5+10*a.getXVelocity(g,i))*c,(i+0.5+10*a.getYVelocity(g,i))*j)}b.stroke();b.restore()}var j,c,i=false,k=document.getElementById("canvas");toggleDisplayFunction=function(c,j){if(j){c.width=
displaySize;c.height=displaySize;return a}c.width=fieldRes;c.height=fieldRes;return b}})();function Pong(b){this.canvas=b;this.ctx=this.canvas.getContext("2d");this.theta=0;this.speed_increase=0.7;this.speed=1;this.ball={x:0,y:0,xo:0,yo:0,out:!1,radius:0,speed:1,color:"red",vx:0,vy:0,ax:0.001,ay:0.001};this.ai={push:!0,suck:!1,stream:[0,0,0],multiplayer:!1,x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.player={push:!1,suck:!1,explode:!1,stream:[0,0,0],x:0,y:0,width:0,height:0,color:"red",vx:0,vy:0,ax:0,ay:0};this.updatePlayer=function(){this.keyMap.up.on&&(this.player.ay=
-this.speed_increase,this.player.vy<-this.speed&&(this.player.vy=-this.speed));this.player.push=this.keyMap.right.on?!0:!1;this.player.suck=this.keyMap.left.on?!0:!1;this.keyMap.down.on&&(this.player.ay=this.speed_increase,this.player.vy>this.speed&&(this.player.vy=this.speed));if(!this.keyMap.down.on&&!this.keyMap.up.on||this.keyMap.down.on&&this.keyMap.up.on)this.player.ay=0,this.player.vy=0;if(0>this.player.y&&0>this.player.vy||this.player.y+this.player.height>this.ctx.canvas.height&&0<this.player.vy)this.player.ay=
0,this.player.vy=0;this.player.vy+=this.player.ay;this.player.y+=this.player.vy};this.updateAi=function(){var a=this.ai,b=this.keyMap,c=this.speed_increase,i=this.speed,k=this.ctx,v=this.ball,l=0;if(a.multiplayer){a.vy+=a.ay;b.up2.on&&(a.ay=-c,a.vy<-i&&(a.vy=-i));a.push=b.left2.on?!0:!1;a.suck=b.right2.on?!0:!1;b.down2.on&&(a.ay=c,a.vy>i&&(a.vy=i));if(!b.down2.on&&!b.up2.on||b.down2.on&&b.up2.on)a.ay=0,a.vy=0;if(0>a.y&&0>a.vy||a.y+a.height>k.canvas.height&&0<a.vy)a.ay=0,a.vy=0;a.y+=a.vy}else l=a.y+
a.height/2,0>v.vx?l<k.canvas.height/2-k.canvas.height/10?a.y+=i:l>k.canvas.height/2+k.canvas.height/10&&(a.y-=i):0<v.vx&&2<Math.abs(v.y-l)&&(v.y<l?a.y-=i:v.y>l&&(a.y+=i));this.ai=a};this.updateBall=function(){var a=this.ball,b=this.player,c=this.theta,i=this.ai,k=this.ctx;Math.abs(a.x-b.x)<Math.abs(a.vx)&&(b.y<a.y+0.1*b.height&&a.y<b.y+1.1*b.height)&&(c=(b.y+b.height/2-a.y)/(b.height/2),a.vx=a.speed*Math.cos(c),a.vy=-a.speed*Math.sin(c));Math.abs(a.x-i.x)<a.vx&&(a.y>i.y&&a.y<i.y+i.height)&&(c=(i.y+
i.height/2-a.y)/(i.height/2),a.vx=-a.speed*Math.cos(c),a.vy=a.speed*Math.sin(c));if(0>a.y&&0>a.vy||a.y+a.radius>k.canvas.height&&0<a.vy)a.vy=-a.vy;if(0>a.x&&0>a.vx||a.x+a.radius>k.canvas.width&&0<a.vx)a.xo=a.x,a.yo=a.y,a.out=!0,a.x=(k.canvas.width-a.radius)/2,a.y=k.canvas.height/2,c=2*Math.random()*Math.PI,c>Math.PI/4&&c<3*Math.PI/4&&(c=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4),c>Math.PI+Math.PI/4&&c<3*Math.PI/4+Math.PI&&(c=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI),
a.vx=a.speed*Math.cos(c),a.vy=a.speed*Math.sin(c),1===Math.round(Math.random())&&(a.vy=-a.vy);a.vx+=a.ax;a.x+=a.vx;a.vy+=a.ay;a.y+=a.vy;this.ball=a};this.distance=function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))};this.update=function(){this.updatePlayer();this.updateAi();this.updateBall()};this.clear=function(){var a=this.ctx;a.save();a.setTransform(1,0,0,1,0,0);a.clearRect(0,0,a.canvas.width,a.canvas.height);a.restore()};this.drawRectangle=function(a,b,c,i,k){this.ctx.fillStyle=
k instanceof Array?"rgb("+Math.floor(k[0])+","+Math.floor(k[1])+","+Math.floor(k[2])+")":k;this.ctx.fillRect(a,b,c,i)};this.drawPlayer=function(a){this.drawRectangle(a.x,a.y,a.width,a.height,a.color)};this.drawBall=function(a){this.ctx.beginPath();this.ctx.lineWidth=0.5;this.ctx.fillStyle="black";this.ctx.strokeStyle="white";this.ctx.arc(a.x,a.y,a.radius,0,2*Math.PI,!1);this.ctx.fill();this.ctx.stroke()};this.render=function(){this.drawPlayer(this.player);this.drawPlayer(this.ai);this.drawBall(this.ball)};
this.loop=function(){this.update();this.render()};this.init=function(){var a=this.ctx.canvas.width/75,b=this.ctx.canvas.height/6,c=this.ctx.canvas.width,i=this.ctx.canvas.height;this.ai.width=a;this.ai.height=b;this.ai.x=c-this.ai.width;this.ai.y=i/2;this.player.width=a;this.player.height=b;this.player.y=i/2;this.ball.radius=2*a;this.theta=Math.PI;this.theta>Math.PI/4&&this.theta<3*Math.PI/4&&(this.theta=1===Math.round(Math.random())?Math.PI/4:3*Math.PI/4);this.theta>Math.PI+Math.PI/4&&this.theta<
3*Math.PI/4+Math.PI&&(this.theta=1===Math.round(Math.random())?Math.PI/4+Math.PI:3*Math.PI/4+Math.PI);this.ball.vx=this.ball.speed*Math.cos(this.theta);this.ball.vy=this.ball.speed*Math.sin(this.theta);this.ball.x=this.ctx.canvas.width/2;this.ball.y=this.ctx.canvas.height/2};this.keyMap={left:{code:65,on:!1},up:{code:87,on:!1},right:{code:68,on:!1},down:{code:83,on:!1},left2:{code:74,on:!1},up2:{code:73,on:!1},right2:{code:76,on:!1},down2:{code:75,on:!1}}};var frames=0,force=5,source=100,sources=[],omx,omy,mx,my,mouseIsDown=!1,res,displaySize=512,fieldRes,clear_id,running=!1,canvas=document.getElementById("canvas"),L=75,distanceRotators=[0,201,401];function multiplayer(){pong.ai.multiplayer=pong.ai.multiplayer?!1:!0;pong.ai.push=!0}function restart(){begin()}function rotator(b){if(0<=b&&200>=b)return[200-(100+b),100];if(200<b&&400>=b)return[-100+(b-200),100-(b-200)];if(400<b&&600>=b)return[100,-100+(b-400)]}var field,pong;function explosion(){}
var counter=0,suck_counter_1=100;
function prepareFrame(b){var a=rotator(distanceRotators[0]),j=rotator(distanceRotators[1]),c=rotator(distanceRotators[2]);pong.player.color=cielabToRGB(L,a[0],a[1],[0.9642,1,0.8249]);pong.ai.color=cielabToRGB(L,j[0],j[1],[0.9642,1,0.8249]);pong.ball.color=cielabToRGB(L,c[0],c[1],[0.9642,1,0.8249]);for(a=0;3>a;a++)distanceRotators[a]++,600<distanceRotators[a]&&(distanceRotators[a]=0);b.setDensityRGB(Math.floor(pong.ball.x+pong.ball.radius/2),Math.floor(pong.ball.y+pong.ball.radius/2),pong.ball.color);
pong.player.push&&(b.setVelocity(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),50,0),b.setDensityRGB(Math.floor(pong.player.x+pong.player.width/2),Math.floor(pong.player.y+pong.player.height/2),pong.player.color));if(pong.ball.out&&(pong.ball.xo>canvas.width/2?(a=canvas.width-1,j=-1):(j=1,a=0),b.setDensityRGB(a,Math.floor(pong.ball.yo+pong.ball.radius/2),pong.ball.color),b.setVelocity(a,Math.floor(pong.ball.yo+pong.ball.radius/2),1E3*j,0),counter++,12==
counter))pong.ball.out=!1,counter=0;pong.player.suck&&(a=pong.distance(pong.player,pong.ball),90<suck_counter_1&100>=suck_counter_1?(b.setVelocity(0,Math.floor(pong.player.y+pong.player.height/2),1E3,0),b.setDensityRGB(0,Math.floor(pong.player.y+pong.player.height/2),pong.player.color),a=100):0==suck_counter_1&&(suck_counter_1=100),20>a&&(pong.ball.x=pong.player.x+10+Math.random(),pong.ball.y=pong.player.y+pong.player.height/2+Math.random(),pong.ball.vx=0,pong.ball.vy=0),console.log(suck_counter_1),
suck_counter_1--);pong.ai.push&&(b.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-50,0),b.setDensityRGB(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),pong.ai.color));pong.ai.suck&&b.setVelocity(Math.floor(pong.ai.x+pong.ai.width/2),Math.floor(pong.ai.y+pong.ai.height/2),-1E3,0)}
function switchAnimation(){running?(running=!1,document.getElementById("switch").innerHTML="Unpause"):(running=!0,document.getElementById("switch").innerHTML="Pause")}var white=[0.9642,1,0.8249];function cielabToRGB(b,a,j,c){x=255*c[0]*inverseCielab(1/116*(b+16)+0.002*a);y=255*c[1]*inverseCielab(1/116*(b+16));z=255*c[2]*inverseCielab(1/116*(b+16)+0.005*j);return[x,y,z]}function inverseCielab(b){return b>6/29?Math.pow(b,3):3*Math.pow(6/29,2)*(b-4/29)}function startAnimation(){running=!0}
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1E3/60)}}();(function animloop(){requestAnimFrame(animloop);updateFrame()})();var filterStrength=20,frameTime=0,lastLoop=new Date,thisLoop,avg=Array(120),avg_index=0,avgs=0,avgs_index=0,benchmarking=!0;
function run_benchmark(){var b=(thisLoop=new Date)-lastLoop;frameTime+=(b-frameTime)/filterStrength;lastLoop=thisLoop;avg[avg_index]=1E3/frameTime;if(6<avg_index){for(var a=b=0;a<avg_index;a++)b+=avg[avg_index];console.log(b/avg_index,avg_index);1<avgs_index&&(60>avgs&&updateRes(24),benchmarking=!1);avgs+=b/avg_index;avgs_index++;avg_index=0}avg_index++}function updateFrame(){running&&(benchmarking&&run_benchmark(),field.update(),pong.loop())}var r=96;
function updateRes(b){canvas.width=b;fieldRes=canvas.height=b;field.setResolution(b,b);pong.init();pong.loop()}var keyDown=function(b){for(var a in pong.keyMap)if(pong.keyMap.hasOwnProperty(a)&&b.keyCode===pong.keyMap[a].code){pong.keyMap[a].on=!0;break}},keyUp=function(b){for(var a in pong.keyMap)if(pong.keyMap.hasOwnProperty(a)&&b.keyCode===pong.keyMap[a].code){pong.keyMap[a].on=!1;break}};
function begin(){field=new FluidField(canvas);field.setUICallback(prepareFrame);field.setDisplayFunction(toggleDisplayFunction(canvas,0));pong=new Pong(canvas);window.addEventListener("keydown",keyDown,!1);window.addEventListener("keyup",keyUp,!1);updateRes(r);startAnimation()}window.onload=begin;
